#!/usr/bin/env bash
# Setup Docker environment variables for Actions Simulator

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

cd "${PROJECT_ROOT}"

echo "ğŸ”§ Dockerç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"

# Get Docker group ID
DOCKER_GID=$(getent group docker | cut -d: -f3 2>/dev/null || echo "999")

# Get user information
USER_ID=$(id -u)
GROUP_ID=$(id -g)

echo "ğŸ“‹ ç’°å¢ƒæƒ…å ±:"
echo "   USER_ID=${USER_ID}"
echo "   GROUP_ID=${GROUP_ID}"
echo "   DOCKER_GID=${DOCKER_GID}"

# Export environment variables for current session
export USER_ID="${USER_ID}"
export GROUP_ID="${GROUP_ID}"
export DOCKER_GID="${DOCKER_GID}"

# Create or update .env file
ENV_FILE=".env"
TEMP_ENV_FILE=".env.tmp"

echo "ğŸ“„ .env ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°ä¸­..."

# Start with existing .env if it exists
if [ -f "${ENV_FILE}" ]; then
    # Remove existing Docker-related variables
    grep -v "^USER_ID=" "${ENV_FILE}" | \
    grep -v "^GROUP_ID=" | \
    grep -v "^DOCKER_GID=" | \
    grep -v "^ACT_LOG_LEVEL=" | \
    grep -v "^ACT_PLATFORM=" | \
    grep -v "^ACTIONS_SIMULATOR_VERBOSE=" > "${TEMP_ENV_FILE}" || true
else
    touch "${TEMP_ENV_FILE}"
fi

# Add Docker environment variables
cat >> "${TEMP_ENV_FILE}" << EOF

# =============================================================================
# MCP Docker Environment - è‡ªå‹•ç”Ÿæˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
# =============================================================================
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚æ‰‹å‹•ç·¨é›†ã¯æ¨å¥¨ã•ã‚Œã¾ã›ã‚“ã€‚
#
# GitHub Personal Access Token (GPAT) ã«ã¤ã„ã¦:
# ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‹ã‚‰è‡ªå‹•çš„ã«å–å¾—ã•ã‚Œã¾ã™ï¼ˆå„ªå…ˆé †ä½é †ï¼‰:
#   1. GITHUB_PERSONAL_ACCESS_TOKEN
#   2. GITHUB_TOKEN
#   3. GH_TOKEN
#
# è¨­å®šæ–¹æ³•:
#   export GITHUB_TOKEN="your_token_here"
#   ã¾ãŸã¯
#   export GITHUB_PERSONAL_ACCESS_TOKEN="your_token_here"
# =============================================================================

# Docker Environment Variables (Auto-generated by setup-docker-env.sh)
USER_ID=${USER_ID}
GROUP_ID=${GROUP_ID}
DOCKER_GID=${DOCKER_GID}

# Actions Simulator Settings
ACT_LOG_LEVEL=info
ACT_PLATFORM=ubuntu-latest=catthehacker/ubuntu:act-latest
ACTIONS_SIMULATOR_VERBOSE=true
EOF

# Replace the original .env file
mv "${TEMP_ENV_FILE}" "${ENV_FILE}"

echo "âœ… .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ"

# Test Docker access
echo "ğŸ³ Dockeræ¥ç¶šãƒ†ã‚¹ãƒˆ..."
if docker version >/dev/null 2>&1; then
    echo "âœ… Dockeræ¥ç¶šOK"
else
    echo "âš ï¸ Dockeræ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™"
    echo "ğŸ’¡ ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
    echo "   sudo usermod -aG docker $USER"
    echo "   newgrp docker"
    echo "   ã¾ãŸã¯"
    echo "   sudo chmod 666 /var/run/docker.sock"
fi

# GitHub Personal Access Token ã®ç¢ºèª
echo "ğŸ”‘ GitHub Personal Access Tokenç¢ºèª..."
if [ -n "${GITHUB_PERSONAL_ACCESS_TOKEN:-}" ]; then
    echo "âœ… GITHUB_PERSONAL_ACCESS_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
elif [ -n "${GITHUB_TOKEN:-}" ]; then
    echo "âœ… GITHUB_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
elif [ -n "${GH_TOKEN:-}" ]; then
    echo "âœ… GH_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
else
    echo "âš ï¸ GitHub Personal Access Token ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
    echo "ğŸ’¡ ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„:"
    echo "   export GITHUB_TOKEN=\"your_token_here\""
    echo "   export GITHUB_PERSONAL_ACCESS_TOKEN=\"your_token_here\""
    echo "   export GH_TOKEN=\"your_token_here\""
fi

echo "âœ… Dockerç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"
