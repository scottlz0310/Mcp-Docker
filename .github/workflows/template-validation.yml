# =============================================================================
# GitHub Actions Simulator - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# =============================================================================
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•æ¤œè¨¼ã‚’è¡Œã„ã¾ã™ã€‚
#
# å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°:
# - ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ™‚ï¼‰
# - ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚
# - æ‰‹å‹•å®Ÿè¡Œæ™‚
# - å®šæœŸå®Ÿè¡Œï¼ˆé€±æ¬¡ï¼‰
#
# æ¤œè¨¼å†…å®¹:
# - æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ï¼ˆYAML, JSON, Shell, Dockerï¼‰
# - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆï¼ˆå®Ÿéš›ã®å‹•ä½œç¢ºèªï¼‰
# - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆç§˜å¯†æƒ…å ±æ¤œå‡ºãªã©ï¼‰
# - æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã®ä¸€è‡´ç¢ºèªï¼‰
# =============================================================================

name: Template Validation

on:
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã®æ¤œè¨¼
  pull_request:
    branches: [main, develop]
    paths:
      - '*.sample'
      - '*.example'
      - '*.template'
      - '.env.example'
      - 'docker-compose.override.yml.sample'
      - '.pre-commit-config.yaml.sample'
      - '.github/workflows/*.yml.sample'
      - '.github/workflows/*.yaml.sample'
      - 'scripts/validate-templates.py'
      - 'scripts/ci-validate-templates.sh'
      - 'tests/test_template_validation.py'

  # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚
  push:
    branches: [main]
    paths:
      - '*.sample'
      - '*.example'
      - '*.template'
      - '.env.example'
      - 'docker-compose.override.yml.sample'
      - '.pre-commit-config.yaml.sample'
      - '.github/workflows/*.yml.sample'
      - '.github/workflows/*.yaml.sample'

  # å®šæœŸå®Ÿè¡Œï¼ˆæ¯Žé€±æœˆæ›œæ—¥ã®åˆå‰6æ™‚ UTCï¼‰
  schedule:
    - cron: '0 6 * * 1'

  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      validation_mode:
        description: 'æ¤œè¨¼ãƒ¢ãƒ¼ãƒ‰'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - syntax-only
          - functionality-only
      output_format:
        description: 'å‡ºåŠ›å½¢å¼'
        required: false
        default: 'text'
        type: choice
        options:
          - text
          - json
      fail_fast:
        description: 'é«˜é€Ÿå¤±æ•—ãƒ¢ãƒ¼ãƒ‰'
        required: false
        default: false
        type: boolean
      verbose:
        description: 'è©³ç´°ãƒ­ã‚°'
        required: false
        default: true
        type: boolean

# ç’°å¢ƒå¤‰æ•°
env:
  PYTHON_VERSION: '3.13'
  UV_CACHE_DIR: /tmp/.uv-cache
  PYTHONUNBUFFERED: 1
  TEMPLATE_VALIDATION_TIMEOUT: 300

# æ¨©é™è¨­å®š
permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ---------------------------------------------------------------------------
  # é«˜é€Ÿæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
  # ---------------------------------------------------------------------------
  syntax-check:
    name: ðŸ” æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: ðŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: âš¡ uv ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: astral-sh/setup-uv@v6
        with:
          version: "latest"
          enable-cache: true

      - name: ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          uv sync --group test --group dev

      - name: ðŸ”§ ã‚·ã‚¹ãƒ†ãƒ ãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck yamllint

          # hadolintã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          HADOLINT_VERSION="2.12.0"
          wget -O /tmp/hadolint "https://github.com/hadolint/hadolint/releases/download/v${HADOLINT_VERSION}/hadolint-Linux-x86_64"
          chmod +x /tmp/hadolint
          sudo mv /tmp/hadolint /usr/local/bin/hadolint

      - name: ðŸ” ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        run: |
          echo "ðŸ” ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."

          validation_args="--check-only"

          if [[ "${{ github.event.inputs.verbose }}" == "true" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            validation_args="$validation_args --verbose"
          fi

          if [[ "${{ github.event.inputs.fail_fast }}" == "true" ]]; then
            validation_args="$validation_args --fail-fast"
          fi

          ./scripts/ci-validate-templates.sh $validation_args

      - name: ðŸ“Š æ§‹æ–‡ãƒã‚§ãƒƒã‚¯çµæžœã‚µãƒžãƒªãƒ¼
        if: always()
        run: |
          echo "ðŸ“Š æ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Œäº†"
          echo "  - YAML/JSONæ§‹æ–‡ãƒã‚§ãƒƒã‚¯: å®Œäº†"
          echo "  - Shellæ§‹æ–‡ãƒã‚§ãƒƒã‚¯: å®Œäº†"
          echo "  - Dockeræ§‹æ–‡ãƒã‚§ãƒƒã‚¯: å®Œäº†"
          echo "  - ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æ–‡ãƒã‚§ãƒƒã‚¯: å®Œäº†"

  # ---------------------------------------------------------------------------
  # æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
  # ---------------------------------------------------------------------------
  functionality-test:
    name: ðŸ§ª æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    needs: syntax-check
    timeout-minutes: 20
    if: ${{ github.event.inputs.validation_mode != 'syntax-only' }}

    steps:
      - name: ðŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v5

      - name: ðŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: âš¡ uv ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: astral-sh/setup-uv@v6
        with:
          version: "latest"
          enable-cache: true

      - name: ðŸ³ Dockerç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: docker/setup-buildx-action@v3

      - name: ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          uv sync --group test --group dev

      - name: ðŸ”§ è¿½åŠ ãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck yamllint

          # hadolintã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          HADOLINT_VERSION="2.12.0"
          wget -O /tmp/hadolint "https://github.com/hadolint/hadolint/releases/download/v${HADOLINT_VERSION}/hadolint-Linux-x86_64"
          chmod +x /tmp/hadolint
          sudo mv /tmp/hadolint /usr/local/bin/hadolint

          # pre-commitã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pip install pre-commit

          # actã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          if ! command -v act >/dev/null 2>&1; then
            echo "âš ï¸ actã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã®ä¸€éƒ¨ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ï¼‰"
          fi

      - name: ðŸ§ª ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          echo "ðŸ§ª ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."

          validation_args="--test-only"

          if [[ "${{ github.event.inputs.verbose }}" == "true" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            validation_args="$validation_args --verbose"
          fi

          if [[ "${{ github.event.inputs.fail_fast }}" == "true" ]]; then
            validation_args="$validation_args --fail-fast"
          fi

          ./scripts/ci-validate-templates.sh $validation_args

      - name: ðŸ“Š æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆçµæžœã‚µãƒžãƒªãƒ¼
        if: always()
        run: |
          echo "ðŸ“Š æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Œäº†"
          echo "  - Docker Composeæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ: å®Œäº†"
          echo "  - GitHub Workflowæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ: å®Œäº†"
          echo "  - pre-commitæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ: å®Œäº†"
          echo "  - ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ: å®Œäº†"

  # ---------------------------------------------------------------------------
  # å®Œå…¨æ¤œè¨¼ï¼ˆæ§‹æ–‡ + æ©Ÿèƒ½ + ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
  # ---------------------------------------------------------------------------
  full-validation:
    name: ðŸ”’ å®Œå…¨æ¤œè¨¼
    runs-on: ubuntu-latest
    needs: [syntax-check]
    timeout-minutes: 25
    if: ${{ github.event.inputs.validation_mode != 'syntax-only' && github.event.inputs.validation_mode != 'functionality-only' }}

    steps:
      - name: ðŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v5

      - name: ðŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: âš¡ uv ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: astral-sh/setup-uv@v6
        with:
          version: "latest"
          enable-cache: true

      - name: ðŸ³ Dockerç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: docker/setup-buildx-action@v3

      - name: ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          uv sync --group test --group dev

      - name: ðŸ”§ å…¨ãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck yamllint jq

          # hadolintã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          HADOLINT_VERSION="2.12.0"
          wget -O /tmp/hadolint "https://github.com/hadolint/hadolint/releases/download/v${HADOLINT_VERSION}/hadolint-Linux-x86_64"
          chmod +x /tmp/hadolint
          sudo mv /tmp/hadolint /usr/local/bin/hadolint

          # pre-commitã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pip install pre-commit

          # Trivyã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ç”¨ï¼‰
          sudo apt-get install wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy

      - name: ðŸ”’ å®Œå…¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼å®Ÿè¡Œ
        run: |
          echo "ðŸ”’ å®Œå…¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼ã‚’å®Ÿè¡Œä¸­..."

          validation_args=""
          output_format="${{ github.event.inputs.output_format || 'text' }}"

          if [[ "$output_format" == "json" ]]; then
            validation_args="$validation_args --format json --output template-validation-report.json"
          fi

          if [[ "${{ github.event.inputs.verbose }}" == "true" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            validation_args="$validation_args --verbose"
          fi

          if [[ "${{ github.event.inputs.fail_fast }}" == "true" ]]; then
            validation_args="$validation_args --fail-fast"
          fi

          ./scripts/ci-validate-templates.sh $validation_args

      - name: ðŸ“Š æ¤œè¨¼çµæžœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: template-validation-results
          path: |
            template-validation-report.json
            template-validation-summary.txt
          retention-days: 30

      - name: ðŸ“‹ æ¤œè¨¼çµæžœã‚µãƒžãƒªãƒ¼è¡¨ç¤º
        if: always()
        run: |
          echo "ðŸ“Š å®Œå…¨æ¤œè¨¼çµæžœã‚µãƒžãƒªãƒ¼"

          if [[ -f "template-validation-report.json" ]] && command -v jq >/dev/null 2>&1; then
            echo "ðŸ“‹ JSONæ¤œè¨¼çµæžœ:"
            jq -r '
              "ç·ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ•°: " + (.total_templates | tostring) + "\n" +
              "æœ‰åŠ¹ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: " + (.valid_templates | tostring) + "\n" +
              "ç„¡åŠ¹ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: " + (.invalid_templates | tostring) + "\n" +
              "è­¦å‘ŠãŒã‚ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: " + (.templates_with_warnings | tostring) + "\n" +
              "æˆåŠŸçŽ‡: " + ((.valid_templates / .total_templates * 100) | floor | tostring) + "%"
            ' template-validation-report.json
          fi

          if [[ -f "template-validation-summary.txt" ]]; then
            echo ""
            echo "ðŸ“‹ è¦ç´„ãƒ¬ãƒãƒ¼ãƒˆ:"
            cat template-validation-summary.txt
          fi

  # ---------------------------------------------------------------------------
  # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆ
  # ---------------------------------------------------------------------------
  validation-system-test:
    name: ðŸ§ª æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v5

      - name: ðŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: âš¡ uv ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: astral-sh/setup-uv@v6
        with:
          version: "latest"
          enable-cache: true

      - name: ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          uv sync --group test --group dev

      - name: ðŸ§ª æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          echo "ðŸ§ª ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          uv run pytest tests/test_template_validation.py -v --tb=short

      - name: ðŸ” æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆå‹•ä½œç¢ºèª
        run: |
          echo "ðŸ” æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®åŸºæœ¬å‹•ä½œã‚’ç¢ºèªä¸­..."

          # æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ã®ã¿ã®ãƒ†ã‚¹ãƒˆ
          python3 scripts/validate-templates.py --check-only --verbose

          echo "âœ… æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œç¢ºèªå®Œäº†"

  # ---------------------------------------------------------------------------
  # çµæžœã‚µãƒžãƒªãƒ¼
  # ---------------------------------------------------------------------------
  validation-summary:
    name: ðŸ“Š æ¤œè¨¼ã‚µãƒžãƒªãƒ¼
    runs-on: ubuntu-latest
    needs: [syntax-check, functionality-test, full-validation, validation-system-test]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v5

      - name: ðŸ“Š æ¤œè¨¼çµæžœã‚µãƒžãƒªãƒ¼ç”Ÿæˆ
        run: |
          echo "ðŸ“Š GitHub Actions Simulator - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼çµæžœã‚µãƒžãƒªãƒ¼"
          echo "============================================================"
          echo ""
          echo "ðŸ• å®Ÿè¡Œæ™‚åˆ»: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ”— ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
          echo "ðŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
          echo "ðŸŽ¯ ã‚¤ãƒ™ãƒ³ãƒˆ: ${{ github.event_name }}"
          echo ""

          # ã‚¸ãƒ§ãƒ–çµæžœã®ç¢ºèª
          echo "ðŸ“‹ ã‚¸ãƒ§ãƒ–å®Ÿè¡Œçµæžœ:"
          echo "  ðŸ” æ§‹æ–‡ãƒã‚§ãƒƒã‚¯: ${{ needs.syntax-check.result }}"
          echo "  ðŸ§ª æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ: ${{ needs.functionality-test.result }}"
          echo "  ðŸ”’ å®Œå…¨æ¤œè¨¼: ${{ needs.full-validation.result }}"
          echo "  ðŸ§ª æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ: ${{ needs.validation-system-test.result }}"
          echo ""

          # å…¨ä½“çš„ãªæˆåŠŸ/å¤±æ•—åˆ¤å®š
          overall_status="success"

          if [[ "${{ needs.syntax-check.result }}" != "success" ]]; then
            overall_status="failure"
            echo "âŒ æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ"
          fi

          if [[ "${{ needs.functionality-test.result }}" == "failure" ]]; then
            overall_status="failure"
            echo "âŒ æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ"
          fi

          if [[ "${{ needs.full-validation.result }}" == "failure" ]]; then
            overall_status="failure"
            echo "âŒ å®Œå…¨æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ"
          fi

          if [[ "${{ needs.validation-system-test.result }}" != "success" ]]; then
            overall_status="failure"
            echo "âŒ æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ"
          fi

          echo ""
          if [[ "$overall_status" = "success" ]]; then
            echo "âœ… å…¨ä½“çµæžœ: æˆåŠŸ"
            echo ""
            echo "ðŸŽ‰ ã™ã¹ã¦ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"
            echo ""
            echo "ðŸ“‹ ç¢ºèªã•ã‚ŒãŸé …ç›®:"
            echo "  - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡æ­£ç¢ºæ€§"
            echo "  - å®Ÿéš›ã®å‹•ä½œæ©Ÿèƒ½ã®ç¢ºèª"
            echo "  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã®æ¤œå‡º"
            echo "  - æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ è‡ªä½“ã®å‹•ä½œç¢ºèª"
          else
            echo "âŒ å…¨ä½“çµæžœ: å¤±æ•—"
            echo ""
            echo "ðŸ”§ å¯¾å¿œãŒå¿…è¦ãªé …ç›®ãŒã‚ã‚Šã¾ã™ã€‚è©³ç´°ã¯å„ã‚¸ãƒ§ãƒ–ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            echo ""
            echo "ðŸ’¡ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:"
            echo "  1. å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–ã®ãƒ­ã‚°ã‚’ç¢ºèª"
            echo "  2. ãƒ­ãƒ¼ã‚«ãƒ«ã§æ¤œè¨¼ã‚’å®Ÿè¡Œ: make validate-templates"
            echo "  3. å€‹åˆ¥ãƒã‚§ãƒƒã‚¯: make validate-templates-syntax"
            echo "  4. æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ: make validate-templates-functionality"
          fi

          echo ""
          echo "============================================================"

      - name: ðŸ“Š GitHub Actions ã‚µãƒžãƒªãƒ¼å‡ºåŠ›
        if: always()
        run: |
          echo "## ðŸ“Š ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚¸ãƒ§ãƒ– | çµæžœ | èª¬æ˜Ž |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ | ${{ needs.syntax-check.result }} | YAML/JSON/Shell/Dockeræ§‹æ–‡ã®æ¤œè¨¼ |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ | ${{ needs.functionality-test.result }} | ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å®Ÿéš›ã®å‹•ä½œç¢ºèª |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ å®Œå…¨æ¤œè¨¼ | ${{ needs.full-validation.result }} | æ§‹æ–‡+æ©Ÿèƒ½+ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®åŒ…æ‹¬çš„æ¤œè¨¼ |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ | ${{ needs.validation-system-test.result }} | æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ è‡ªä½“ã®å‹•ä½œç¢ºèª |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.syntax-check.result }}" == "success" ]] && \
             [[ "${{ needs.functionality-test.result }}" != "failure" ]] && \
             [[ "${{ needs.full-validation.result }}" != "failure" ]] && \
             [[ "${{ needs.validation-system-test.result }}" == "success" ]]; then
            echo "âœ… **ã™ã¹ã¦ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã¯å„ã‚¸ãƒ§ãƒ–ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®æ¤œè¨¼æ–¹æ³•" >> $GITHUB_STEP_SUMMARY
          echo "```bash" >> $GITHUB_STEP_SUMMARY
          echo "# å®Œå…¨ãªæ¤œè¨¼" >> $GITHUB_STEP_SUMMARY
          echo "make validate-templates" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ã®ã¿" >> $GITHUB_STEP_SUMMARY
          echo "make validate-templates-syntax" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã®ã¿" >> $GITHUB_STEP_SUMMARY
          echo "make validate-templates-functionality" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
