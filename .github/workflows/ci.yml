---
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_call: # å†åˆ©ç”¨å¯èƒ½ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨ã—ã¦ä½¿ç”¨å¯èƒ½ã«ã™ã‚‹

permissions:
  contents: read
  security-events: write
  checks: write

jobs:
  fast-lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10 # æ˜Žç¤ºçš„ãªã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install linting tools
        run: |
          # shellcheckã¯æ—¢ã«ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹
          # yamllint, ruffã®ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pip install yamllint ruff

      # fast-lintã§ã¯ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ä¸è¦ï¼ˆruffã®ã¿ã§ååˆ†ï¼‰

      - name: Run ruff (Python)
        run: ruff check .

      - name: Run shellcheck (Shell)
        run: |
          # Note: --severity=error ã§ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ™ãƒ«ã®ã¿ãƒã‚§ãƒƒã‚¯ï¼ˆwarning/infoã¯è¨±å®¹ï¼‰
          find . -name "*.sh" -type f -not -path "./.venv/*" -not -path "./node_modules/*" -exec shellcheck --severity=error {} +

      - name: Run yamllint (YAML)
        run: yamllint .

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Run MegaLinter
        run: |
          # Note: å¸¸ã«å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆVALIDATE_ALL_CODEBASE=trueï¼‰
          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãƒã‚§ãƒƒã‚¯ã™ã‚‹å ´åˆã¯ã€VALIDATE_ALL_CODEBASE=falseã«ã—ã¦
          # GitHub Actionsã®ç’°å¢ƒå¤‰æ•°ã‚’æ´»ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
          docker run --rm \
            -v $(pwd):/tmp/lint \
            -e APPLY_FIXES=none \
            -e DEFAULT_WORKSPACE=/tmp/lint \
            -e MEGALINTER_CONFIG=.mega-linter.yml \
            -e VALIDATE_ALL_CODEBASE=true \
            oxsecurity/megalinter:v7

      - name: Upload MegaLinter reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mega-linter-reports
          path: megalinter-reports/
          if-no-files-found: warn

  build:
    runs-on: ubuntu-latest
    needs: fast-lint
    steps:
      - uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('Dockerfile', 'docker-compose.yml') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build Docker image with buildx
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64 # å°†æ¥çš„ã« linux/amd64,linux/arm64 å¯¾å¿œäºˆå®š
          push: false
          load: true # ãƒ­ãƒ¼ã‚«ãƒ«ã®Docker daemonã«èª­ã¿è¾¼ã¿
          tags: mcp-docker:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          if [ -d /tmp/.buildx-cache-new ]; then
            mv /tmp/.buildx-cache-new /tmp/.buildx-cache
          fi

      - name: Display Docker images
        run: |
          if command -v docker >/dev/null 2>&1; then
            docker images
          else
            echo "Docker not available in this environment"
          fi

      - name: Test Docker image basic functionality
        run: |
          if command -v docker >/dev/null 2>&1; then
            # Test main.py version command
            docker run --rm mcp-docker:latest python /app/main.py --version
            # Test default command (mcp-server-github)
            # Note: MCPã‚µãƒ¼ãƒãƒ¼ã¯--helpã§ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã™å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€å‡ºåŠ›ã®ã¿ç¢ºèª
            docker run --rm mcp-docker:latest --help > /dev/null 2>&1 || echo "MCP server executed (exit code expected)"
            # Inspect image
            docker inspect mcp-docker:latest
          else
            echo "Docker not available in this environment - skipping tests"
            exit 0
          fi

  security:
    runs-on: ubuntu-latest
    needs: fast-lint # buildã‚¸ãƒ§ãƒ–ã«ä¾å­˜ã›ãšã€fast-lintã®ã¿ã«ä¾å­˜
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image for security scan
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true # ãƒ­ãƒ¼ã‚«ãƒ«ã®Docker daemonã«èª­ã¿è¾¼ã¿
          tags: mcp-docker:latest

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: "mcp-docker:latest"
          format: "sarif"
          output: "trivy-results.sarif"
          exit-code: "0"
          severity: "CRITICAL,HIGH"
          trivyignores: ".trivyignore"
          ignore-unfixed: true
          skip-dirs: "__pycache__,.git,node_modules"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      - name: Run Trivy for PR comment
        uses: aquasecurity/trivy-action@0.33.1
        if: github.event_name == 'pull_request'
        with:
          image-ref: "mcp-docker:latest"
          format: "table"
          exit-code: "1"
          severity: "CRITICAL,HIGH"
          trivyignores: ".trivyignore"
          ignore-unfixed: true
          skip-dirs: "__pycache__,.git,node_modules"

  pytest:
    name: ðŸ§ª Pytest (unit/integration/e2e)
    runs-on: ubuntu-latest
    needs: fast-lint
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install act
        run: |
          # Note: -b ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã‚’æŒ‡å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯./binï¼‰
          curl -fsSL https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash -s -- -b /usr/local/bin
          act --version

      - name: Install dependencies
        run: uv sync --group test

      - name: Run pytest (unit tests)
        id: unit-tests
        run: |
          uv run pytest tests/unit/ -v --tb=short --maxfail=5
        continue-on-error: false

      - name: Run pytest (integration tests - actions)
        id: integration-actions
        run: |
          # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
          if find tests/integration/actions/ -name "test_*.py" -o -name "*_test.py" 2>/dev/null | grep -q .; then
            uv run pytest tests/integration/actions/ -v --tb=short
          else
            echo "No Python test files found in tests/integration/actions/, skipping..."
            exit 0
          fi

      - name: Run pytest (integration tests - services)
        id: integration-services
        run: |
          # tests/integration/services/ ã«ã¯ Python ãƒ†ã‚¹ãƒˆãŒãªã„å ´åˆãŒã‚ã‚‹ãŸã‚ã€
          # å­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
          if find tests/integration/services/ -name "test_*.py" -o -name "*_test.py" 2>/dev/null | grep -q .; then
            uv run pytest tests/integration/services/ -v --tb=short
          else
            echo "No Python test files found in tests/integration/services/, skipping..."
            exit 0
          fi

      - name: Run pytest (integration tests - common)
        id: integration-common
        run: |
          # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
          if find tests/integration/common/ -name "test_*.py" -o -name "*_test.py" 2>/dev/null | grep -q .; then
            uv run pytest tests/integration/common/ -v --tb=short
          else
            echo "No Python test files found in tests/integration/common/, skipping..."
            exit 0
          fi

      - name: Run pytest (e2e tests - selected)
        id: e2e-tests
        run: |
          uv run pytest tests/e2e/test_comprehensive_integration.py -v --tb=short

      - name: Summary test results
        if: always()
        run: |
          echo "## ãƒ†ã‚¹ãƒˆçµæžœã‚µãƒžãƒª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ steps.unit-tests.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration (Actions): ${{ steps.integration-actions.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration (Services): ${{ steps.integration-services.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration (Common): ${{ steps.integration-common.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- E2E Tests: ${{ steps.e2e-tests.outcome }}" >> $GITHUB_STEP_SUMMARY

  bats-test:
    name: ðŸ§ª Bats Test (shell scripts)
    runs-on: ubuntu-latest
    needs: fast-lint
    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --group test

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image for testing
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true # ãƒ­ãƒ¼ã‚«ãƒ«ã®Docker daemonã«èª­ã¿è¾¼ã¿
          tags: mcp-docker:latest

      - name: Install Bats
        run: |
          echo "ðŸ” Environment Detection"
          echo "OS: $(uname -s) $(uname -r)"
          echo "User: $(whoami) (UID: $(id -u))"
          echo "Groups: $(groups)"

          # ========================================
          # STEP 1: æ¨©é™ãƒ¬ãƒ™ãƒ«æ¤œè¨¼ï¼ˆéžã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–é™å®šï¼‰
          # ========================================
          ROOT_USER=false
          SUDO_NOPASSWD=false

          echo "ðŸ” Permission Level Detection (Non-Interactive Only)"

          if [ "$(id -u)" -eq 0 ]; then
            echo "âœ… Running as root user"
            ROOT_USER=true
          elif timeout 2 sudo -n true 2>/dev/null; then
            echo "âœ… sudo available without password"
            SUDO_NOPASSWD=true
          else
            echo "â„¹ï¸  No passwordless sudo - will use user-space alternatives"
            echo "   This is normal and expected in most local environments"
          fi

          # ========================================
          # STEP 2: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼æ¤œè¨¼
          # ========================================
          echo ""
          echo "ðŸ“¦ Package Manager Detection"
          APT_AVAILABLE=false
          BREW_AVAILABLE=false
          YUM_AVAILABLE=false

          if command -v apt-get >/dev/null 2>&1; then
            echo "âœ… apt-get available"
            APT_AVAILABLE=true
          fi

          if command -v brew >/dev/null 2>&1; then
            echo "âœ… brew available"
            BREW_AVAILABLE=true
          fi

          if command -v yum >/dev/null 2>&1; then
            echo "âœ… yum available"
            YUM_AVAILABLE=true
          fi

          # ========================================
          # STEP 3: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æˆ¦ç•¥æ±ºå®šãƒ»å®Ÿè¡Œ
          # ========================================
          echo ""
          echo "ðŸŽ¯ Installation Strategy Selection"

          INSTALL_SUCCESS=false

          # æˆ¦ç•¥1: Root + apt
          if [ "$ROOT_USER" = true ] && [ "$APT_AVAILABLE" = true ]; then
            echo "ðŸ“‹ Strategy 1: Root + apt-get"
            if apt-get update && apt-get install -y bats; then
              echo "âœ… Strategy 1 succeeded"
              INSTALL_SUCCESS=true
            else
              echo "âŒ Strategy 1 failed"
            fi
          fi

          # æˆ¦ç•¥2: sudo(no-passwd) + apt
          if [ "$INSTALL_SUCCESS" = false ] && [ "$SUDO_NOPASSWD" = true ] && [ "$APT_AVAILABLE" = true ]; then
            echo "ðŸ“‹ Strategy 2: sudo(no-passwd) + apt-get"
            if timeout 10 sudo apt-get update && timeout 30 sudo apt-get install -y bats; then
              echo "âœ… Strategy 2 succeeded"
              INSTALL_SUCCESS=true
            else
              echo "âŒ Strategy 2 failed"
            fi
          fi

          # æˆ¦ç•¥3: brew (ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸è¦)
          if [ "$INSTALL_SUCCESS" = false ] && [ "$BREW_AVAILABLE" = true ]; then
            echo "ðŸ“‹ Strategy 3: brew install"
            if brew install bats-core; then
              echo "âœ… Strategy 3 succeeded"
              INSTALL_SUCCESS=true
            else
              echo "âŒ Strategy 3 failed"
            fi
          fi

          # æˆ¦ç•¥4: Manual installation (æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)
          if [ "$INSTALL_SUCCESS" = false ]; then
            echo "ðŸ“‹ Strategy 4: Manual installation (fallback)"
            echo "Downloading bats-core from GitHub..."
            if command -v wget >/dev/null 2>&1; then
              DOWNLOAD_CMD="wget -O"
            elif command -v curl >/dev/null 2>&1; then
              DOWNLOAD_CMD="curl -L -o"
            else
              echo "âŒ No download tool available (wget/curl)"
              exit 1
            fi

            # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            mkdir -p "$HOME/bin" "$HOME/.local/bin"
            cd /tmp

            if $DOWNLOAD_CMD bats-core.tar.gz https://github.com/bats-core/bats-core/archive/v1.10.0.tar.gz && \
              tar -xzf bats-core.tar.gz && \
              (cd bats-core-1.10.0 && ./install.sh "$HOME"); then

              # PATHè¨­å®š
              export PATH="$HOME/bin:$PATH"
              # Note: .bashrcãŒå­˜åœ¨ã—ãªã„å ´åˆã‚‚ã‚ã‚‹ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
              echo "export PATH=\"\$HOME/bin:\$PATH\"" >> "$HOME/.bashrc" 2>/dev/null || true

              # GitHub Actionsç’°å¢ƒå¤‰æ•°è¨­å®š
              if [ -n "$GITHUB_ENV" ]; then
                echo "PATH=$HOME/bin:$PATH" >> "$GITHUB_ENV"
              fi

              echo "âœ… Strategy 4 succeeded"
              INSTALL_SUCCESS=true
            else
              echo "âŒ Strategy 4 failed"
            fi
          fi

          # ========================================
          # STEP 4: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
          # ========================================
          echo ""
          echo "ðŸ”¬ Installation Verification"

          # PATHç¢ºèªãƒ»æ›´æ–°
          export PATH="$HOME/bin:$HOME/.local/bin:$PATH"

          if command -v bats >/dev/null 2>&1; then
            BATS_PATH=$(which bats)
            BATS_VERSION=$(bats --version)
            echo "âœ… Bats installation successful"
            echo "   Path: $BATS_PATH"
            echo "   Version: $BATS_VERSION"
          else
            echo "âŒ Bats installation failed - not found in PATH"
            echo "   Current PATH: $PATH"
            echo "   Contents of \$HOME/bin: $(ls -la $HOME/bin/ 2>/dev/null || echo 'directory not found')"
            exit 1
          fi

      - name: Run Bats test suite
        env:
          USER_ID: 1001
          GROUP_ID: 1001
          GITHUB_PERSONAL_ACCESS_TOKEN: "dummy_token_for_ci"
        run: |
          # PATHè¨­å®šï¼ˆAlpineç­‰ã®ç’°å¢ƒå¯¾å¿œï¼‰
          export PATH=$HOME/bin:$PATH

          echo "Running environment check..."
          echo "Bats location: $(which bats || echo 'not found')"
          echo "Docker availability: $(command -v docker >/dev/null && echo 'available' || echo 'not available')"
          echo "Make availability: $(command -v make >/dev/null && echo 'available' || echo 'not available')"

          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆæ–°ã—ã„ãƒ†ã‚¹ãƒˆæ§‹é€ ã«å¯¾å¿œï¼‰
          if command -v bats >/dev/null 2>&1; then
            echo "ðŸ§ª Running integration bats tests..."

            # Actions Simulatorãƒ†ã‚¹ãƒˆ
            if ls tests/integration/actions/*.bats 1> /dev/null 2>&1; then
              echo "Running actions tests..."
              bats tests/integration/actions/*.bats
            fi

            # ã‚µãƒ¼ãƒ“ã‚¹çµ±åˆãƒ†ã‚¹ãƒˆ
            if ls tests/integration/services/*.bats 1> /dev/null 2>&1; then
              echo "Running services tests..."
              bats tests/integration/services/*.bats
            fi

            # å…±é€šãƒ†ã‚¹ãƒˆ
            if ls tests/integration/common/*.bats 1> /dev/null 2>&1; then
              echo "Running common tests..."
              bats tests/integration/common/*.bats
            fi

            # ãƒ«ãƒ¼ãƒˆã«æ®‹ã£ã¦ã„ã‚‹.batsãƒ•ã‚¡ã‚¤ãƒ«
            if ls tests/integration/*.bats 1> /dev/null 2>&1; then
              echo "Running root level tests..."
              bats tests/integration/*.bats
            fi
          else
            echo "âŒ Bats not available - tests cannot run"
            exit 1
          fi

      - name: Cleanup
        if: always()
        # Note: ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ãªã„å ´åˆã‚‚ã‚ã‚‹ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
        run: docker compose down -v || true

  docker-services-integration:
    name: ðŸ³ Docker Services Integration
    runs-on: ubuntu-latest
    needs: fast-lint
    steps:
      - uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv sync --group test

      - name: Build and start services
        env:
          USER_ID: 1001
          GROUP_ID: 1001
          GITHUB_PERSONAL_ACCESS_TOKEN: "dummy_token_for_ci"
        run: |
          docker compose build
          docker compose up -d github-mcp datetime-validator actions-simulator
          sleep 30

      - name: Check service health
        env:
          GITHUB_PERSONAL_ACCESS_TOKEN: "dummy_token_for_ci"
        run: |
          echo "ðŸ” Service Health Check"
          docker compose ps
          echo ""
          echo "ðŸ“œ Service Logs"
          docker compose logs --tail=50

      - name: Run service integration tests
        id: service-tests
        env:
          GITHUB_PERSONAL_ACCESS_TOKEN: "dummy_token_for_ci"
        run: |
          echo "ðŸ§ª Running Docker service integration tests..."
          # tests/integration/services/ ã«ã¯ Python ãƒ†ã‚¹ãƒˆãŒãªã„å ´åˆãŒã‚ã‚‹ãŸã‚ã€
          # å­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
          if find tests/integration/services/ -name "test_*.py" -o -name "*_test.py" 2>/dev/null | grep -q .; then
            uv run pytest tests/integration/services/ -v --tb=short
          else
            echo "No Python test files found in tests/integration/services/, skipping..."
            exit 0
          fi

      - name: Cleanup
        if: always()
        env:
          GITHUB_PERSONAL_ACCESS_TOKEN: "dummy_token_for_ci"
        run: docker compose down -v
