# =============================================================================
# GitHub Actions Simulator - å“è³ªã‚²ãƒ¼ãƒˆçµ±åˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# =============================================================================
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«å“è³ªã‚²ãƒ¼ãƒˆã‚’çµ±åˆã—ã€
# é…å¸ƒå“è³ªãƒã‚§ãƒƒã‚¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œè¨¼ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼ã‚’è‡ªå‹•åŒ–ã—ã¾ã™ã€‚
#
# å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°:
# - ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ï¼ˆå“è³ªãƒã‚§ãƒƒã‚¯ï¼‰
# - ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ï¼ˆå®Œå…¨æ¤œè¨¼ï¼‰
# - ãƒªãƒªãƒ¼ã‚¹å‰ï¼ˆå“è³ªç¢ºèªï¼‰
# - å®šæœŸå®Ÿè¡Œï¼ˆå“è³ªç›£è¦–ï¼‰
#
# å“è³ªã‚²ãƒ¼ãƒˆ:
# 1. é…å¸ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯
# 2. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§æ¤œè¨¼
# 3. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‹•ä½œç¢ºèª
# 4. ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰æ¤œè¨¼
# 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¤œè¨¼
# =============================================================================

name: ğŸ›¡ï¸ Quality Gates

on:
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã®å“è³ªãƒã‚§ãƒƒã‚¯
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]

  # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚
  push:
    branches: [main]

  # ãƒªãƒªãƒ¼ã‚¹å‰ã®å“è³ªç¢ºèª
  workflow_call:
    inputs:
      release_mode:
        description: 'ãƒªãƒªãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§ã®å®Ÿè¡Œ'
        required: false
        type: boolean
        default: false
      quality_level:
        description: 'å“è³ªãƒ¬ãƒ™ãƒ« (basic|standard|strict)'
        required: false
        type: string
        default: 'standard'

  # å®šæœŸå®Ÿè¡Œï¼ˆæ¯æ—¥åˆå‰2æ™‚ UTCï¼‰
  schedule:
    - cron: '0 2 * * *'

  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      quality_level:
        description: 'å“è³ªãƒ¬ãƒ™ãƒ«'
        required: false
        default: 'standard'
        type: choice
        options:
          - basic
          - standard
          - strict
      skip_slow_tests:
        description: 'æ™‚é–“ã®ã‹ã‹ã‚‹ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—'
        required: false
        default: false
        type: boolean
      generate_reports:
        description: 'è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ'
        required: false
        default: true
        type: boolean

# ç’°å¢ƒå¤‰æ•°
env:
  PYTHON_VERSION: '3.13'
  UV_CACHE_DIR: /tmp/.uv-cache
  QUALITY_GATE_TIMEOUT: 1800  # 30åˆ†
  PYTHONUNBUFFERED: 1

# æ¨©é™è¨­å®š
permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write
  checks: write

jobs:
  # ---------------------------------------------------------------------------
  # å“è³ªã‚²ãƒ¼ãƒˆè¨­å®šã¨å‰å‡¦ç†
  # ---------------------------------------------------------------------------
  quality-gate-setup:
    name: ğŸ”§ å“è³ªã‚²ãƒ¼ãƒˆè¨­å®š
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      quality-level: ${{ steps.config.outputs.quality-level }}
      skip-slow-tests: ${{ steps.config.outputs.skip-slow-tests }}
      generate-reports: ${{ steps.config.outputs.generate-reports }}
      release-mode: ${{ steps.config.outputs.release-mode }}
      changed-files: ${{ steps.changes.outputs.changed-files }}
      needs-full-validation: ${{ steps.changes.outputs.needs-full-validation }}

    steps:
      - name: ğŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ğŸ”§ å“è³ªã‚²ãƒ¼ãƒˆè¨­å®š
        id: config
        run: |
          # å“è³ªãƒ¬ãƒ™ãƒ«ã®æ±ºå®š
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            QUALITY_LEVEL="strict"
          elif [[ "${{ github.event_name }}" == "workflow_call" ]] && [[ "${{ inputs.release_mode }}" == "true" ]]; then
            QUALITY_LEVEL="strict"
          elif [[ "${{ github.event_name }}" == "push" ]] && [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            QUALITY_LEVEL="standard"
          else
            QUALITY_LEVEL="${{ inputs.quality_level || 'basic' }}"
          fi

          # ãã®ä»–ã®è¨­å®š
          SKIP_SLOW_TESTS="${{ inputs.skip_slow_tests || 'false' }}"
          GENERATE_REPORTS="${{ inputs.generate_reports || 'true' }}"
          RELEASE_MODE="${{ inputs.release_mode || 'false' }}"

          # å‡ºåŠ›
          echo "quality-level=$QUALITY_LEVEL" >> $GITHUB_OUTPUT
          echo "skip-slow-tests=$SKIP_SLOW_TESTS" >> $GITHUB_OUTPUT
          echo "generate-reports=$GENERATE_REPORTS" >> $GITHUB_OUTPUT
          echo "release-mode=$RELEASE_MODE" >> $GITHUB_OUTPUT

          echo "ğŸ¯ å“è³ªãƒ¬ãƒ™ãƒ«: $QUALITY_LEVEL"
          echo "âš¡ é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰: $SKIP_SLOW_TESTS"
          echo "ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ: $GENERATE_REPORTS"
          echo "ğŸš€ ãƒªãƒªãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰: $RELEASE_MODE"

      - name: ğŸ” å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡º
        id: changes
        run: |
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œå‡º
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # PRã®å ´åˆã¯å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
            git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt
          else
            # ãã®ä»–ã®å ´åˆã¯å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¯¾è±¡
            find . -type f \( -name "*.py" -o -name "*.sh" -o -name "*.yml" -o -name "*.yaml" -o -name "*.md" -o -name "*.sample" -o -name "*.example" \) > changed_files.txt
          fi

          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†æ
          CHANGED_FILES=$(cat changed_files.txt | tr '\n' ',' | sed 's/,$//')

          # å®Œå…¨æ¤œè¨¼ãŒå¿…è¦ã‹ã©ã†ã‹ã®åˆ¤å®š
          NEEDS_FULL_VALIDATION="false"

          if grep -qE "(scripts/|\.github/workflows/|Makefile|pyproject\.toml|requirements|setup)" changed_files.txt; then
            NEEDS_FULL_VALIDATION="true"
          fi

          if [[ "${{ github.event_name }}" == "schedule" ]] || [[ "${{ github.event_name }}" == "workflow_call" ]]; then
            NEEDS_FULL_VALIDATION="true"
          fi

          echo "changed-files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "needs-full-validation=$NEEDS_FULL_VALIDATION" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $(wc -l < changed_files.txt)"
          echo "ğŸ” å®Œå…¨æ¤œè¨¼å¿…è¦: $NEEDS_FULL_VALIDATION"

  # ---------------------------------------------------------------------------
  # é…å¸ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯
  # ---------------------------------------------------------------------------
  distribution-quality-check:
    name: ğŸ“¦ é…å¸ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    needs: quality-gate-setup
    timeout-minutes: 15
    if: ${{ contains(needs.quality-gate-setup.outputs.changed-files, 'scripts/') || needs.quality-gate-setup.outputs.needs-full-validation == 'true' }}

    steps:
      - name: ğŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v5

      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: âš¡ uv ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: astral-sh/setup-uv@v6
        with:
          version: "latest"
          enable-cache: true

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          uv sync --group test --group dev

      - name: ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ ãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck yamllint jq

      - name: ğŸ” é…å¸ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ” é…å¸ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ä¸­..."

          # Shellæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ (error ãƒ¬ãƒ™ãƒ«ã®ã¿)
          find scripts/ -name "*.sh" -type f -exec shellcheck --severity=error {} +

          # Pythonæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
          find scripts/ -name "*.py" -type f -exec python3 -m py_compile {} +

          echo "âœ… æ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Œäº†"

      - name: ğŸ§ª é…å¸ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        run: |
          echo "ğŸ§ª é…å¸ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆä¸­..."

          # run-actions.sh ã®åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
          timeout 60 ./scripts/run-actions.sh --help

          # ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
          timeout 60 ./scripts/run-actions.sh --check-deps || true

          # ãã®ä»–ã®ä¸»è¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ˜ãƒ«ãƒ—è¡¨ç¤ºãƒ†ã‚¹ãƒˆ
          for script in scripts/*.sh; do
            if [[ -x "$script" ]]; then
              echo "Testing $script..."
              timeout 30 "$script" --help 2>/dev/null || true
            fi
          done

          echo "âœ… æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Œäº†"

      - name: ğŸ“Š é…å¸ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆå“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹
        run: |
          echo "ğŸ“Š é…å¸ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ä¸­..."

          # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è¤‡é›‘åº¦åˆ†æ
          echo "### é…å¸ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆå“è³ªãƒ¬ãƒãƒ¼ãƒˆ" > distribution-quality-report.md
          echo "" >> distribution-quality-report.md

          echo "#### ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¸€è¦§" >> distribution-quality-report.md
          find scripts/ -name "*.sh" -type f | while read -r script; do
            lines=$(wc -l < "$script")
            functions=$(grep -c "^[[:space:]]*function\|^[[:space:]]*[a-zA-Z_][a-zA-Z0-9_]*[[:space:]]*(" "$script" || echo "0")
            echo "- $script: $lines è¡Œ, $functions é–¢æ•°" >> distribution-quality-report.md
          done

          echo "" >> distribution-quality-report.md
          echo "#### å“è³ªãƒã‚§ãƒƒã‚¯çµæœ" >> distribution-quality-report.md
          echo "- æ§‹æ–‡ãƒã‚§ãƒƒã‚¯: âœ… é€šé" >> distribution-quality-report.md
          echo "- æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ: âœ… é€šé" >> distribution-quality-report.md
          echo "- å®Ÿè¡Œæ™‚åˆ»: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> distribution-quality-report.md

          echo "âœ… å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†å®Œäº†"

      - name: ğŸ“„ é…å¸ƒå“è³ªãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: distribution-quality-report
          path: distribution-quality-report.md
          retention-days: 30

  # ---------------------------------------------------------------------------
  # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§æ¤œè¨¼ï¼ˆãƒ†ã‚¹ãƒˆæœªå®Ÿè£…ã®ãŸã‚ç„¡åŠ¹åŒ–ï¼‰
  # ---------------------------------------------------------------------------
  documentation-validation:
    name: ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§æ¤œè¨¼
    runs-on: ubuntu-latest
    needs: quality-gate-setup
    timeout-minutes: 10
    if: false  # ãƒ†ã‚¹ãƒˆæœªå®Ÿè£…ã®ãŸã‚ç„¡åŠ¹åŒ–

    steps:
      - name: ğŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v5

      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: âš¡ uv ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: astral-sh/setup-uv@v6
        with:
          version: "latest"
          enable-cache: true

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          uv sync --group test --group dev

      - name: ğŸ”§ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œè¨¼ãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y yamllint

          # markdownlintã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          npm install -g markdownlint-cli

      - name: ğŸ” ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        run: |
          echo "ğŸ” ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ä¸­..."

          # æ–°ã—ã„ãƒ†ã‚¹ãƒˆæ§‹é€ : tests/integration/é…ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
          uv run pytest tests/integration/test_documentation_consistency.py -v --tb=short

          echo "âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å®Œäº†"

      - name: ğŸ“ Markdownæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ“ Markdownæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ä¸­..."

          # markdownlintã§Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
          markdownlint README.md docs/ --ignore node_modules || {
            echo "âš ï¸ Markdownæ§‹æ–‡ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ãŒã€å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™"
          }

          echo "âœ… Markdownæ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Œäº†"

      - name: ğŸ”— ãƒªãƒ³ã‚¯æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ”— ãƒªãƒ³ã‚¯æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯ä¸­..."

          # å†…éƒ¨ãƒªãƒ³ã‚¯ã®æœ‰åŠ¹æ€§ã‚’ãƒã‚§ãƒƒã‚¯
          python3 -c "
          import os
          import re
          from pathlib import Path

          def check_internal_links():
              issues = []
              for md_file in Path('.').rglob('*.md'):
                  content = md_file.read_text(encoding='utf-8', errors='ignore')

                  # å†…éƒ¨ãƒªãƒ³ã‚¯ã‚’æ¤œå‡º
                  links = re.findall(r'\[.*?\]\(([^)]+)\)', content)
                  for link in links:
                      if not link.startswith('http') and not link.startswith('#'):
                          # ç›¸å¯¾ãƒ‘ã‚¹ã®å ´åˆ
                          target_path = md_file.parent / link
                          if not target_path.exists():
                              issues.append(f'{md_file}: ãƒªãƒ³ã‚¯åˆ‡ã‚Œ {link}')

              return issues

          issues = check_internal_links()
          if issues:
              print('âš ï¸ ãƒªãƒ³ã‚¯åˆ‡ã‚ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:')
              for issue in issues[:10]:  # æœ€åˆã®10ä»¶ã®ã¿è¡¨ç¤º
                  print(f'  - {issue}')
              if len(issues) > 10:
                  print(f'  ... ä»– {len(issues) - 10} ä»¶')
          else:
              print('âœ… å†…éƒ¨ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯å®Œäº†')
          "

          echo "âœ… ãƒªãƒ³ã‚¯æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯å®Œäº†"

  # ---------------------------------------------------------------------------
  # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼ï¼ˆç°¡ç´ åŒ–è¨ˆç”»ã«ã‚ˆã‚Šç„¡åŠ¹åŒ–ï¼‰
  # ---------------------------------------------------------------------------
  template-validation:
    name: ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼
    runs-on: ubuntu-latest
    needs: quality-gate-setup
    timeout-minutes: 20
    if: false  # ç°¡ç´ åŒ–è¨ˆç”»ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ãŸãŸã‚ç„¡åŠ¹åŒ–

    steps:
      - name: ğŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v5

      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: âš¡ uv ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: astral-sh/setup-uv@v6
        with:
          version: "latest"
          enable-cache: true

      - name: ğŸ³ Dockerç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          uv sync --group test --group dev

      - name: ğŸ”§ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼ãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck yamllint jq

          # hadolintã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          HADOLINT_VERSION="2.12.0"
          wget -O /tmp/hadolint "https://github.com/hadolint/hadolint/releases/download/v${HADOLINT_VERSION}/hadolint-Linux-x86_64"
          chmod +x /tmp/hadolint
          sudo mv /tmp/hadolint /usr/local/bin/hadolint

          # pre-commitã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pip install pre-commit

      - name: ğŸ” ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼å®Ÿè¡Œ
        run: |
          echo "ğŸ” ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼ä¸­..."

          # æ—¢å­˜ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
          ./scripts/ci-validate-templates.sh --verbose

          echo "âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼å®Œäº†"

      - name: ğŸ§ª ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        run: |
          echo "ğŸ§ª ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆä¸­..."

          # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
          uv run pytest tests/test_template_validation.py -v --tb=short

          echo "âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Œäº†"

  # ---------------------------------------------------------------------------
  # ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰æ¤œè¨¼
  # ---------------------------------------------------------------------------
  end-to-end-validation:
    name: ğŸ”„ ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰æ¤œè¨¼
    runs-on: ubuntu-latest
    needs: [quality-gate-setup, distribution-quality-check, documentation-validation, template-validation]
    timeout-minutes: 30
    if: ${{ needs.quality-gate-setup.outputs.quality-level != 'basic' && needs.quality-gate-setup.outputs.skip-slow-tests != 'true' }}

    steps:
      - name: ğŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v5

      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: âš¡ uv ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: astral-sh/setup-uv@v6
        with:
          version: "latest"
          enable-cache: true

      - name: ğŸ³ Dockerç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          uv sync --group test --group dev

      - name: ğŸ”„ ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          echo "ğŸ”„ ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆä¸­..."

          # ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
          uv run pytest tests/test_end_to_end_user_experience.py -v --tb=short

          echo "âœ… ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆå®Œäº†"

      - name: ğŸ—ï¸ çµ±åˆãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
        run: |
          echo "ğŸ—ï¸ çµ±åˆãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆä¸­..."

          # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
          docker build -t github-actions-simulator:test .

          # åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
          docker run --rm github-actions-simulator:test --help

          echo "âœ… çµ±åˆãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆå®Œäº†"

  # ---------------------------------------------------------------------------
  # åŒ…æ‹¬çš„å“è³ªæ¤œè¨¼ï¼ˆå³æ ¼ãƒ¢ãƒ¼ãƒ‰ï¼‰
  # ---------------------------------------------------------------------------
  comprehensive-quality-validation:
    name: ğŸ›¡ï¸ åŒ…æ‹¬çš„å“è³ªæ¤œè¨¼
    runs-on: ubuntu-latest
    needs: [quality-gate-setup, end-to-end-validation]
    timeout-minutes: 45
    if: ${{ needs.quality-gate-setup.outputs.quality-level == 'strict' }}

    steps:
      - name: ğŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v5

      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: âš¡ uv ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: astral-sh/setup-uv@v6
        with:
          version: "latest"
          enable-cache: true

      - name: ğŸ³ Dockerç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          uv sync --group test --group dev

      - name: ğŸ§ª åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œ
        run: |
          echo "ğŸ§ª åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œä¸­..."

          # åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã‚’å®Ÿè¡Œ
          ./scripts/run-comprehensive-tests.sh --ci --report

          echo "âœ… åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Œäº†"

      - name: ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼
        run: |
          echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ä¸­..."

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã®å®Ÿè¡Œ
          if command -v trivy >/dev/null 2>&1; then
            # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
            docker build -t github-actions-simulator:security-test .
            trivy image --exit-code 0 --severity HIGH,CRITICAL github-actions-simulator:security-test
          else
            echo "âš ï¸ TrivyãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
          fi

          echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼å®Œäº†"

      - name: âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¤œè¨¼
        run: |
          echo "âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¤œè¨¼ä¸­..."

          # åŸºæœ¬çš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
          time_start=$(date +%s)

          # é…å¸ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œæ™‚é–“æ¸¬å®š
          timeout 300 ./scripts/run-actions.sh --help >/dev/null 2>&1 || true

          time_end=$(date +%s)
          duration=$((time_end - time_start))

          echo "ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµæœ:"
          echo "  - é…å¸ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆå¿œç­”æ™‚é–“: ${duration}ç§’"

          # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŸºæº–ã®ãƒã‚§ãƒƒã‚¯
          if [[ $duration -gt 30 ]]; then
            echo "âš ï¸ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è­¦å‘Š: é…å¸ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å¿œç­”æ™‚é–“ãŒ30ç§’ã‚’è¶…ãˆã¦ã„ã¾ã™"
          else
            echo "âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã™"
          fi

          echo "âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¤œè¨¼å®Œäº†"

  # ---------------------------------------------------------------------------
  # å“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  # ---------------------------------------------------------------------------
  quality-report-generation:
    name: ğŸ“Š å“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    runs-on: ubuntu-latest
    needs: [quality-gate-setup, distribution-quality-check, documentation-validation, template-validation, end-to-end-validation, comprehensive-quality-validation]
    if: ${{ always() && needs.quality-gate-setup.outputs.generate-reports == 'true' }}
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v5

      - name: ğŸ“„ å“è³ªãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v5
        with:
          pattern: "*-quality-report*"
          merge-multiple: true
        continue-on-error: false

      - name: ğŸ“Š çµ±åˆå“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        run: |
          echo "ğŸ“Š çµ±åˆå“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."

          # çµ±åˆãƒ¬ãƒãƒ¼ãƒˆã®ä½œæˆ
          cat > quality-gate-report.md << 'EOF'
          # GitHub Actions Simulator - å“è³ªã‚²ãƒ¼ãƒˆå®Ÿè¡Œãƒ¬ãƒãƒ¼ãƒˆ

          ## å®Ÿè¡Œæƒ…å ±

          - **å®Ÿè¡Œæ™‚åˆ»**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **å“è³ªãƒ¬ãƒ™ãƒ«**: ${{ needs.quality-gate-setup.outputs.quality-level }}
          - **ãƒªãƒªãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰**: ${{ needs.quality-gate-setup.outputs.release-mode }}
          - **ã‚¤ãƒ™ãƒ³ãƒˆ**: ${{ github.event_name }}
          - **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref_name }}
          - **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}

          ## å“è³ªã‚²ãƒ¼ãƒˆçµæœ

          | æ¤œè¨¼é …ç›® | çµæœ | è©³ç´° |
          |----------|------|------|
          | é…å¸ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯ | ${{ needs.distribution-quality-check.result }} | æ§‹æ–‡ãƒ»æ©Ÿèƒ½ãƒ»å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ |
          | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§æ¤œè¨¼ | ${{ needs.documentation-validation.result }} | æ•´åˆæ€§ãƒ»æ§‹æ–‡ãƒ»ãƒªãƒ³ã‚¯ |
          | ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼ | ${{ needs.template-validation.result }} | æ§‹æ–‡ãƒ»æ©Ÿèƒ½ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ |
          | ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰æ¤œè¨¼ | ${{ needs.end-to-end-validation.result }} | çµ±åˆãƒ»ãƒ“ãƒ«ãƒ‰ãƒ»æ©Ÿèƒ½ |
          | åŒ…æ‹¬çš„å“è³ªæ¤œè¨¼ | ${{ needs.comprehensive-quality-validation.result }} | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ |

          ## æ¨å¥¨äº‹é …

          EOF

          # çµæœã«åŸºã¥ãæ¨å¥¨äº‹é …ã®è¿½åŠ 
          if [[ "${{ needs.distribution-quality-check.result }}" != "success" ]]; then
            echo "- âŒ é…å¸ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å“è³ªå•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„" >> quality-gate-report.md
          fi

          if [[ "${{ needs.documentation-validation.result }}" != "success" ]]; then
            echo "- âŒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ•´åˆæ€§å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„" >> quality-gate-report.md
          fi

          if [[ "${{ needs.template-validation.result }}" != "success" ]]; then
            echo "- âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ¤œè¨¼å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„" >> quality-gate-report.md
          fi

          if [[ "${{ needs.end-to-end-validation.result }}" != "success" ]]; then
            echo "- âŒ ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰æ¤œè¨¼ã®å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„" >> quality-gate-report.md
          fi

          if [[ "${{ needs.comprehensive-quality-validation.result }}" != "success" ]]; then
            echo "- âŒ åŒ…æ‹¬çš„å“è³ªæ¤œè¨¼ã®å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„" >> quality-gate-report.md
          fi

          # å…¨ã¦æˆåŠŸã®å ´åˆ
          if [[ "${{ needs.distribution-quality-check.result }}" == "success" ]] && \
             [[ "${{ needs.documentation-validation.result }}" == "success" ]] && \
             [[ "${{ needs.template-validation.result }}" == "success" ]] && \
             [[ "${{ needs.end-to-end-validation.result }}" == "success" ]]; then
            echo "- âœ… ã™ã¹ã¦ã®å“è³ªã‚²ãƒ¼ãƒˆãŒæ­£å¸¸ã«é€šéã—ã¾ã—ãŸ" >> quality-gate-report.md
            echo "- ğŸ‰ é…å¸ƒå“è³ªåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã™" >> quality-gate-report.md
          fi

          echo "" >> quality-gate-report.md
          echo "---" >> quality-gate-report.md
          echo "ç”Ÿæˆæ™‚åˆ»: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> quality-gate-report.md

          echo "âœ… çµ±åˆå“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"

      - name: ğŸ“„ å“è³ªãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: quality-gate-report
          path: |
            quality-gate-report.md
            *-quality-report*
          retention-days: 90

      - name: ğŸ“‹ GitHub Actions ã‚µãƒãƒªãƒ¼å‡ºåŠ›
        run: |
          echo "## ğŸ›¡ï¸ å“è³ªã‚²ãƒ¼ãƒˆå®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # çµæœãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
          echo "| æ¤œè¨¼é …ç›® | çµæœ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| é…å¸ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯ | ${{ needs.distribution-quality-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§æ¤œè¨¼ | ${{ needs.documentation-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼ | ${{ needs.template-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰æ¤œè¨¼ | ${{ needs.end-to-end-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| åŒ…æ‹¬çš„å“è³ªæ¤œè¨¼ | ${{ needs.comprehensive-quality-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # å…¨ä½“çµæœã®åˆ¤å®š
          if [[ "${{ needs.distribution-quality-check.result }}" == "success" ]] && \
             [[ "${{ needs.documentation-validation.result }}" == "success" ]] && \
             [[ "${{ needs.template-validation.result }}" == "success" ]] && \
             [[ "${{ needs.end-to-end-validation.result }}" == "success" ]]; then
            echo "âœ… **ã™ã¹ã¦ã®å“è³ªã‚²ãƒ¼ãƒˆãŒæ­£å¸¸ã«é€šéã—ã¾ã—ãŸ**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **å“è³ªã‚²ãƒ¼ãƒˆã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“Š **å“è³ªãƒ¬ãƒ™ãƒ«**: ${{ needs.quality-gate-setup.outputs.quality-level }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ• **å®Ÿè¡Œæ™‚åˆ»**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # å“è³ªã‚²ãƒ¼ãƒˆçµæœé€šçŸ¥
  # ---------------------------------------------------------------------------
  quality-gate-notification:
    name: ğŸ“¢ å“è³ªã‚²ãƒ¼ãƒˆçµæœé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [quality-gate-setup, distribution-quality-check, documentation-validation, template-validation, end-to-end-validation, comprehensive-quality-validation, quality-report-generation]
    if: ${{ always() }}
    timeout-minutes: 5

    steps:
      - name: ğŸ“Š å“è³ªã‚²ãƒ¼ãƒˆçµæœåˆ¤å®š
        id: result
        run: |
          # å…¨ä½“çµæœã®åˆ¤å®š
          overall_success="true"

          if [[ "${{ needs.distribution-quality-check.result }}" == "failure" ]]; then
            overall_success="false"
          fi

          if [[ "${{ needs.documentation-validation.result }}" == "failure" ]]; then
            overall_success="false"
          fi

          if [[ "${{ needs.template-validation.result }}" == "failure" ]]; then
            overall_success="false"
          fi

          if [[ "${{ needs.end-to-end-validation.result }}" == "failure" ]]; then
            overall_success="false"
          fi

          if [[ "${{ needs.comprehensive-quality-validation.result }}" == "failure" ]]; then
            overall_success="false"
          fi

          echo "overall-success=$overall_success" >> $GITHUB_OUTPUT

          if [[ "$overall_success" == "true" ]]; then
            echo "ğŸ‰ å“è³ªã‚²ãƒ¼ãƒˆ: å…¨ä½“æˆåŠŸ"
          else
            echo "âŒ å“è³ªã‚²ãƒ¼ãƒˆ: å¤±æ•—"
          fi

      - name: ğŸ“¢ ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚³ãƒ¡ãƒ³ãƒˆ
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v8
        with:
          script: |
            const overallSuccess = '${{ steps.result.outputs.overall-success }}' === 'true';
            const qualityLevel = '${{ needs.quality-gate-setup.outputs.quality-level }}';

            const results = {
              'é…å¸ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆå“è³ªãƒã‚§ãƒƒã‚¯': '${{ needs.distribution-quality-check.result }}',
              'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§æ¤œè¨¼': '${{ needs.documentation-validation.result }}',
              'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œè¨¼': '${{ needs.template-validation.result }}',
              'ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰æ¤œè¨¼': '${{ needs.end-to-end-validation.result }}',
              'åŒ…æ‹¬çš„å“è³ªæ¤œè¨¼': '${{ needs.comprehensive-quality-validation.result }}'
            };

            let comment = `## ğŸ›¡ï¸ å“è³ªã‚²ãƒ¼ãƒˆå®Ÿè¡Œçµæœ\n\n`;
            comment += `**å“è³ªãƒ¬ãƒ™ãƒ«**: ${qualityLevel}\n`;
            comment += `**å…¨ä½“çµæœ**: ${overallSuccess ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}\n\n`;
            comment += `### è©³ç´°çµæœ\n\n`;

            for (const [name, result] of Object.entries(results)) {
              const icon = result === 'success' ? 'âœ…' : result === 'failure' ? 'âŒ' : 'â­ï¸';
              comment += `- ${icon} ${name}: ${result}\n`;
            }

            if (!overallSuccess) {
              comment += `\n### ğŸ’¡ æ¨å¥¨äº‹é …\n\n`;
              comment += `å¤±æ•—ã—ãŸå“è³ªã‚²ãƒ¼ãƒˆã®è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèªã—ã€å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚\n`;
              comment += `è©³ç´°ãªå“è³ªãƒ¬ãƒãƒ¼ãƒˆã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚\n`;
            }

            comment += `\n---\n`;
            comment += `ğŸ• å®Ÿè¡Œæ™‚åˆ»: ${new Date().toISOString()}\n`;
            comment += `ğŸ”— ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: [å“è³ªã‚²ãƒ¼ãƒˆ](${context.payload.repository.html_url}/actions/runs/${context.runId})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: ğŸ¯ å“è³ªã‚²ãƒ¼ãƒˆæœ€çµ‚çµæœ
        run: |
          if [[ "${{ steps.result.outputs.overall-success }}" == "true" ]]; then
            echo "ğŸ‰ å“è³ªã‚²ãƒ¼ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
            echo "âœ… é…å¸ƒå“è³ªåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã™"
            exit 0
          else
            echo "âŒ å“è³ªã‚²ãƒ¼ãƒˆã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "ğŸ”§ ä¿®æ­£ãŒå¿…è¦ãªé …ç›®ãŒã‚ã‚Šã¾ã™"
            exit 1
          fi
