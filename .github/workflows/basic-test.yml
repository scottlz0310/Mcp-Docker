# =============================================================================
# GitHub Actions Simulator - åŸºæœ¬ãƒ†ã‚¹ãƒˆç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
# =============================================================================
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯è»½é‡ãªãƒ†ã‚¹ãƒˆå®Ÿè¡Œã«ç‰¹åŒ–ã—ãŸã‚µãƒ³ãƒ—ãƒ«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã™ã€‚
# é«˜é€Ÿãªå®Ÿè¡Œã‚’é‡è¦–ã—ã€å¿…è¦æœ€å°é™ã®ãƒ†ã‚¹ãƒˆã®ã¿ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
#
# ä½¿ç”¨æ–¹æ³•:
#   1. ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ .github/workflows/basic-test.yml ã«ã‚³ãƒ”ãƒ¼
#   2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦ãƒ†ã‚¹ãƒˆè¨­å®šã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
#   3. GitHub Actions Simulator ã§å®Ÿè¡Œ: make actions-run WORKFLOW=.github/workflows/basic-test.yml
#
# ç‰¹å¾´:
#   - é«˜é€Ÿå®Ÿè¡Œï¼ˆ5-10åˆ†ä»¥å†…ï¼‰
#   - åŸºæœ¬çš„ãªãƒªãƒ³ãƒˆã¨ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®ã¿
#   - è»½é‡ãªactãƒ™ãƒ¼ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«æœ€é©åŒ–
# =============================================================================

name: Basic Test Pipeline

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š - ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã®é«˜é€Ÿãƒã‚§ãƒƒã‚¯ç”¨
on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  workflow_dispatch:

# ç’°å¢ƒå¤‰æ•°
env:
  PYTHON_VERSION: '3.13'
  PYTHONUNBUFFERED: 1
  UV_CACHE_DIR: /tmp/.uv-cache

# æ¨©é™è¨­å®š
permissions:
  contents: read

jobs:
  # ---------------------------------------------------------------------------
  # åŸºæœ¬ãƒã‚§ãƒƒã‚¯ï¼ˆãƒªãƒ³ãƒˆ + å˜ä½“ãƒ†ã‚¹ãƒˆï¼‰
  # ---------------------------------------------------------------------------
  basic-test:
    name: ğŸ§ª åŸºæœ¬ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v5

      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: âš¡ uv ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
        run: |
          if ! command -v uv &> /dev/null; then
            echo "uvãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™..."
            curl -LsSf https://astral.sh/uv/install.sh | sh
            export PATH="$HOME/.local/bin:$PATH"
          fi
          uv --version

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          if [ -f "pyproject.toml" ]; then
            uv sync --group dev
          else
            echo "â„¹ï¸ pyproject.toml ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

      - name: ğŸ” ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ (Ruff)
        run: |
          if [ -f "pyproject.toml" ] && find . -name "*.py" -type f | head -1 | grep -q .; then
            echo "ğŸ” Ruffã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯..."
            uv run ruff check . --output-format=github --exclude .cache
            uv run ruff format --check . --exclude .cache
          else
            echo "â„¹ï¸ Pythonãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

      - name: ğŸ§ª å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          if [ -d "tests/unit" ]; then
            echo "ğŸ§ª pytestã«ã‚ˆã‚‹å˜ä½“ãƒ†ã‚¹ãƒˆ..."
            uv run pytest tests/unit/ --tb=short --maxfail=5
          elif [ -d "tests" ]; then
            echo "ğŸ§ª pytestã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
            uv run pytest tests/ --tb=short --maxfail=5
          else
            echo "â„¹ï¸ ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

      - name: âœ… çµæœã‚µãƒãƒªãƒ¼
        if: always()
        run: |
          echo "ğŸ“Š åŸºæœ¬ãƒ†ã‚¹ãƒˆå®Œäº†"
          echo "  - ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯: å®Œäº†"
          echo "  - å˜ä½“ãƒ†ã‚¹ãƒˆ: å®Œäº†"
          echo ""
          echo "ğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: çµ±åˆãƒ†ã‚¹ãƒˆã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œ"
