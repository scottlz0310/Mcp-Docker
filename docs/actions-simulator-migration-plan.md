# GitHub Actions Simulator Migration Plan

**作成日**: 2025-10-14
**対象**: GitHub Actions Simulator (`services/actions/*`) → `act` ベース CI互換モード (`make actions-ci`)
**作成者**: MCP Docker Team

---

## 1. 背景と現状整理

- 旧実装: `services/actions/` 配下の Python サービス。CLI (`make actions-run`) とテストスイートの大半が依存。診断機能やハング検知など複数の補助サービスを統合しているが、構造が複雑。
- 新実装: `.actrc` でフル互換イメージ (`ghcr.io/catthehacker/ubuntu:full-24.04`) を固定し、`make actions-ci` 経由で `act -W <workflow>` を直接起動。CI 環境との差異を最小化。
- 既存テスト: 旧サービス API を直接 Import する構造で、新実装に切り替えるとテスト破綻が確定している。

> 課題: 旧サービスの複雑な機能をどう取り扱うか、テストフレームワークの移行、ドキュメント更新が未整備。

---

## 2. 目標

- 旧 `services/actions` 実装を段階的に廃止し、`act` ベースの CI 互換ワークフローに統一。
- ユーザー向け CLI / Make ターゲットを新実装に切り替えても違和感なく利用できる状態をつくる。
- テストスイートと補助スクリプトを新実装に追随させ、継続的な保守コストを削減。
- ロールバック・観測手段を確保し、移行による開発体験の劣化を防ぐ。

---

## 3. 対象範囲 / 非対象

**対象**
- `services/actions` モジュール群の依存洗い出しと段階的削除
- Makefile ターゲット・CLI (`main.py`) の統一方針
- テスト（ユニット/統合/E2E）と自動化スクリプトの更新
- ドキュメント・開発手順の刷新

**非対象**
- GitHub Release Watcher 等、Actions Simulator 以外のサービス
- Docker Compose 構成の抜本的見直し（必要な範囲の調整に留める）
- Windows/macOS 固有要件の追加対応（既存カバレッジを維持）

---

## 4. ステークホルダー

- **Migration Owner**: Actions Simulator 開発担当
- **QA / Testing**: テスト自動化担当
- **Dev Experience**: 内部利用者 (開発チーム)
- **Ops / CI**: CI/CD パイプライン管理者

---

## 5. フェーズ別計画

### Phase 0: 調査と設計確定（~1 週間）
- 旧サービス API の利用箇所を静的解析 (`rg`, `pytest` import) と実行ログで特定。
- 新実装で不足している機能（診断、ハング検知、ログ収集など）を棚卸しし、代替案可否を判断。
- テストスイートの分類（新実装で継続 vs 廃止 vs 置換）を策定。
- 成果物:
  - 旧サービス機能マッピング表
  - テスト移行対象リスト
  - フィーチャーパリティ要件

### Phase 1: ブリッジとテスト対応（~2 週間）
- 旧 Python サービスから新 `act` 実行を呼び出す暫定ブリッジ層を作成し、主要フローを `act` 経由で動作させる。
- ユニット/統合テストをブリッジに対応させつつ、旧 API 依存テストを Feature Flag またはマークで切り分ける。
- `make actions-run` と `make actions-ci` の操作感を揃え、ユーザー向けドキュメントの暫定更新。
- 成果物:
  - ブリッジ層実装
  - テストのスキップ/移行方針
  - 更新済み README / 開発者ガイド

### Phase 2: フル切り替え準備（~2 週間）
- ブリッジ層を介したテストをすべて `act` ベースに書き換え、旧サービス固有コードの利用をゼロにする。
- 旧サービス機能のうち継続価値があるもの（例: ハング検知）を個別ツールや `act` ラッパースクリプトとして再実装/外部化。
- 旧 `services/actions` を「deprecated」ステータスにし、利用を検知する lint/CI チェックを導入。
- 成果物:
  - `services/actions` を参照しないテスト群
  - 補助機能の再提供手段
  - CI チェック（旧 API 利用検出）

### Phase 3: 削除とクリーンアップ（~1 週間）
- 旧 `services/actions` ディレクトリを削除し、関連依存（インポート・設定・ドキュメント）を整理。
- Makefile・CLI・スクリプトから旧ターゲット/オプションを外し、`make actions-run` を `make actions-ci` に統一。
- 最終ドキュメント更新、学習共有（事後レビュー）を実施。
- 成果物:
  - クリーンなコードベース（旧実装削除）
  - 更新済みドキュメント一式
  - レトロスペクティブレポート

---

## 6. テスト戦略

- **段階的移行**: Phase 1 で互換層を用意し、CI を緑で維持したままリファクタリングを進行。
- **サニティチェック**: `make actions-ci` で主要ワークフローを定期実行し、旧実装削除前にベースラインを確立。
- **比較検証**: 旧/新実行結果の差分ログを収集し、重大差異がないか確認。
- **テストタグ運用**: `pytest` マーカーまたは BATS の環境変数で旧 API 依存テストを識別し、移行状況を可視化。

---

## 7. リスクと対策

| リスク | 説明 | 対策 |
| ------ | ---- | ---- |
| 旧機能の未提供 | 診断/トレース/自動復旧など | 必要な機能をモジュール化し、`act` 実行前後にフックを提供 |
| テスト保守コスト増 | 暫定ブリッジ期間中の二重実装 | ブリッジの期間を最小化し、利用状況をダッシュボードで追跡 |
| ドキュメント不整合 | 新旧手順が混在 | フェーズごとに公開ドキュメントを更新し、旧手順には明確な警告を付与 |
| 開発者体験の劣化 | ローカル実行が遅くなる可能性 | `act` のキャッシュ設定、軽量オプションの周知、ハードウェア要件の明記 |

---

## 8. 成功指標

- `services/actions` 配下のコードが参照されなくなる（静的解析でゼロ）。
- CI / ローカル双方で `make actions-ci` のみで主要ワークフローが完遂。
- テストスイートが `act` ベースで安定的に緑を維持。
- ドキュメントの更新が完了し、旧手順の問い合わせがゼロ化。

---

## 9. オープンクエスチョン

1. 旧サービスにのみ存在するハング検知・自動復旧機能をどこまで再実装するか？
2. `act` 実行時のログ収集/可視化要件をどのように満たすか？
3. Windows/WSL 利用者に向けたガイドをどこまで整備するか？
4. ブリッジ期間中のサポート窓口（問い合わせ管理方法）は？

---

## 10. 次のステップ

1. Phase 0 の担当と締切を決定し、調査タスクをチケット化。
2. `services/actions` 依存箇所の一覧を作成し、優先度順に移行スケジュールを組む。
3. フィーチャーパリティ要件に基づいて必要なラッパー／ツール再実装の見積もりを実施。
4. ドキュメント公開タイミングとコミュニケーションプラン（社内説明会等）を調整。
