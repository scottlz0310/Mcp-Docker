# =============================================================================
# GitHub Actions Simulator - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
# =============================================================================
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã«ç‰¹åŒ–ã—ãŸã‚µãƒ³ãƒ—ãƒ«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã™ã€‚
# è„†å¼±æ€§æ¤œå‡ºã€ç§˜å¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³ã€ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
#
# ä½¿ç”¨æ–¹æ³•:
#   1. ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ .github/workflows/security-scan.yml ã«ã‚³ãƒ”ãƒ¼
#   2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
#   3. GitHub Actions Simulator ã§å®Ÿè¡Œ: make actions-run WORKFLOW=.github/workflows/security-scan.yml
#
# ç‰¹å¾´:
#   - åŒ…æ‹¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
#   - Trivyã€TruffleHogã€pip-auditã‚’ä½¿ç”¨
#   - SARIFå½¢å¼ã§ã®ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
# =============================================================================

name: Security Scan Pipeline

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ç”¨
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ã®åˆå‰6æ™‚ï¼ˆUTCï¼‰ã«å®šæœŸå®Ÿè¡Œ
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      scan_severity:
        description: 'ã‚¹ã‚­ãƒ£ãƒ³é‡è¦åº¦ãƒ¬ãƒ™ãƒ«'
        required: false
        default: 'HIGH'
        type: choice
        options:
          - CRITICAL
          - HIGH
          - MEDIUM
          - LOW
      include_unfixed:
        description: 'ä¿®æ­£ä¸å¯èƒ½ãªè„†å¼±æ€§ã‚‚å«ã‚ã‚‹'
        required: false
        default: false
        type: boolean

# ç’°å¢ƒå¤‰æ•°
env:
  SCAN_SEVERITY: ${{ github.event.inputs.scan_severity || 'HIGH' }}
  INCLUDE_UNFIXED: ${{ github.event.inputs.include_unfixed || 'false' }}

# æ¨©é™è¨­å®š
permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ---------------------------------------------------------------------------
  # ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
  # ---------------------------------------------------------------------------
  filesystem-scan:
    name: ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆç§˜å¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³ç”¨ï¼‰

      - name: ğŸ” ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ (Trivy)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: ${{ env.SCAN_SEVERITY }},CRITICAL
          exit-code: '0'
          trivyignores: '.trivyignore'

      - name: ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-fs-results.sarif'

      - name: ğŸ” ç§˜å¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³ (TruffleHog)
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified --no-verification

      - name: ğŸ“‹ ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚µãƒãƒªãƒ¼
        if: always()
        run: |
          echo "ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"
          echo "  - è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³: å®Œäº†"
          echo "  - ç§˜å¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³: å®Œäº†"
          echo "  - é‡è¦åº¦ãƒ¬ãƒ™ãƒ«: ${{ env.SCAN_SEVERITY }}"

  # ---------------------------------------------------------------------------
  # ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
  # ---------------------------------------------------------------------------
  dependency-scan:
    name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v5

      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: âš¡ uv ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: ğŸ“¦ Pythonä¾å­˜é–¢ä¿‚è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
        run: |
          if [ -f "pyproject.toml" ] || [ -f "requirements.txt" ]; then
            echo "ğŸ Pythonä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

            # pip-auditã‚’ä½¿ç”¨ã—ãŸè„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
            uv tool install pip-audit
            uv tool run pip-audit \
              --format=json \
              --output=python-vulnerabilities.json \
              --progress-spinner=off || {
              echo "âš ï¸ Pythonä¾å­˜é–¢ä¿‚ã«è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
              # é‡å¤§ãªè„†å¼±æ€§ã®ã¿ã§å¤±æ•—ã•ã›ã‚‹
              uv tool run pip-audit --format=text | grep -i "critical\|high" && exit 1 || true
            }
          else
            echo "â„¹ï¸ Pythonä¾å­˜é–¢ä¿‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

      - name: ğŸ“¦ Node.jsä¾å­˜é–¢ä¿‚è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
        if: hashFiles('package.json') != ''
        run: |
          echo "ğŸ“¦ Node.jsä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

          # Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
          curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
          sudo apt-get install -y nodejs

          # npm auditã®å®Ÿè¡Œ
          npm audit --audit-level=high --json > node-vulnerabilities.json || {
            echo "âš ï¸ Node.jsä¾å­˜é–¢ä¿‚ã«è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            npm audit --audit-level=high
          }

      - name: ğŸ“Š ä¾å­˜é–¢ä¿‚ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-scan-results
          path: |
            python-vulnerabilities.json
            node-vulnerabilities.json
          retention-days: 30

  # ---------------------------------------------------------------------------
  # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
  # ---------------------------------------------------------------------------
  container-scan:
    name: ğŸ³ ã‚³ãƒ³ãƒ†ãƒŠã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: hashFiles('Dockerfile') != ''

    steps:
      - name: ğŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v5

      - name: ğŸ³ Docker Buildx ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”¨ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: security-scan:latest

      - name: ğŸ” Dockerã‚¤ãƒ¡ãƒ¼ã‚¸è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ (Trivy)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: 'security-scan:latest'
          format: 'sarif'
          output: 'trivy-image-results.sarif'
          severity: ${{ env.SCAN_SEVERITY }},CRITICAL
          exit-code: '1'
          trivyignores: '.trivyignore'
          ignore-unfixed: ${{ env.INCLUDE_UNFIXED == 'false' }}

      - name: ğŸ“Š ã‚³ãƒ³ãƒ†ãƒŠã‚¹ã‚­ãƒ£ãƒ³çµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-image-results.sarif'

      - name: ğŸ³ ã‚¤ãƒ¡ãƒ¼ã‚¸æƒ…å ±è¡¨ç¤º
        if: always()
        run: |
          echo "ğŸ“Š Dockerã‚¤ãƒ¡ãƒ¼ã‚¸æƒ…å ±:"
          docker images security-scan:latest
          docker history security-scan:latest --no-trunc

  # ---------------------------------------------------------------------------
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  # ---------------------------------------------------------------------------
  security-report:
    name: ğŸ“Š ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆ
    runs-on: ubuntu-latest
    needs: [filesystem-scan, dependency-scan, container-scan]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v5

      - name: ğŸ“Š ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        run: |
          echo "ğŸ“Š ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚µãƒãƒªãƒ¼"
          echo "=================================="
          echo ""
          echo "ğŸ• ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œæ™‚åˆ»: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”— ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
          echo "ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
          echo "âš™ï¸ é‡è¦åº¦ãƒ¬ãƒ™ãƒ«: ${{ env.SCAN_SEVERITY }}"
          echo ""

          # ã‚¹ã‚­ãƒ£ãƒ³çµæœã®ç¢ºèª
          echo "ğŸ“‹ ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œçµæœ:"
          echo "  ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚¹ã‚­ãƒ£ãƒ³: ${{ needs.filesystem-scan.result }}"
          echo "  ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¹ã‚­ãƒ£ãƒ³: ${{ needs.dependency-scan.result }}"
          echo "  ğŸ³ ã‚³ãƒ³ãƒ†ãƒŠã‚¹ã‚­ãƒ£ãƒ³: ${{ needs.container-scan.result }}"
          echo ""

          # å…¨ä½“çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ…‹ã®åˆ¤å®š
          security_status="secure"

          if [ "${{ needs.filesystem-scan.result }}" == "failure" ]; then
            security_status="vulnerable"
            echo "âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          fi

          if [ "${{ needs.dependency-scan.result }}" == "failure" ]; then
            security_status="vulnerable"
            echo "âŒ ä¾å­˜é–¢ä¿‚ã«è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          fi

          if [ "${{ needs.container-scan.result }}" == "failure" ]; then
            security_status="vulnerable"
            echo "âŒ ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã«è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          fi

          echo ""
          if [ "$security_status" = "secure" ]; then
            echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ…‹: è‰¯å¥½"
            echo ""
            echo "ğŸ‰ é‡å¤§ãªè„†å¼±æ€§ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚"
            echo ""
            echo "ğŸ“‹ æ¨å¥¨äº‹é …:"
            echo "  1. å®šæœŸçš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã®ç¶™ç¶š"
            echo "  2. ä¾å­˜é–¢ä¿‚ã®å®šæœŸæ›´æ–°"
            echo "  3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®éµå®ˆ"
          else
            echo "âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ…‹: è¦æ³¨æ„"
            echo ""
            echo "ğŸ”§ å¯¾å¿œãŒå¿…è¦ãªé …ç›®:"
            echo "  1. æ¤œå‡ºã•ã‚ŒãŸè„†å¼±æ€§ã®ç¢ºèªã¨ä¿®æ­£"
            echo "  2. ä¾å­˜é–¢ä¿‚ã®æ›´æ–°"
            echo "  3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒã®é©ç”¨"
            echo ""
            echo "ğŸ’¡ ãƒ˜ãƒ«ãƒ—:"
            echo "  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰: docs/SECURITY.md"
            echo "  - è„†å¼±æ€§å¯¾å¿œæ‰‹é †: docs/VULNERABILITY_RESPONSE.md"
          fi

          echo ""
          echo "=================================="

      - name: ğŸ“Š ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆæƒ…å ±
        run: |
          echo "ğŸ“Š ç”Ÿæˆã•ã‚ŒãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆ:"
          echo "  - trivy-fs-results.sarif: ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚¹ã‚­ãƒ£ãƒ³çµæœ"
          echo "  - trivy-image-results.sarif: ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³çµæœ"
          echo "  - dependency-scan-results: ä¾å­˜é–¢ä¿‚ã‚¹ã‚­ãƒ£ãƒ³çµæœ"
          echo ""
          echo "ğŸ’¡ ãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèªæ–¹æ³•:"
          echo "  1. GitHub Security ã‚¿ãƒ–ã§SARIFãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèª"
          echo "  2. Actions ã® Artifacts ã‹ã‚‰JSONãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
          echo "  3. è©³ç´°ãªåˆ†æãŒå¿…è¦ãªå ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§Trivyã‚’å®Ÿè¡Œ"
