---
services:
  github-mcp:
    build: .
    container_name: mcp-github
    stdin_open: true
    tty: true
    environment:
      # GPAT: .env -> ç’°å¢ƒå¤‰æ•° -> ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®é †ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_PERSONAL_ACCESS_TOKEN:-${GITHUB_TOKEN:-${GH_TOKEN:-your_token_here}}}
    restart: unless-stopped
    command:
      [
        "node",
        "/usr/local/lib/node_modules/@modelcontextprotocol/server-github/dist/index.js",
      ]
    networks:
      - mcp-network

  datetime-validator:
    build: .
    container_name: mcp-datetime
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: å‹•çš„UID/GIDè¨­å®šï¼ˆæ›¸ãè¾¼ã¿æ¨©é™ç¢ºä¿ + Rootæ˜‡æ ¼é˜²æ­¢ï¼‰
    user: "${USER_ID:-1000}:${GROUP_ID:-1000}"
    volumes:
      - ~/workspace:/workspace:ro # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: èª­ã¿å–ã‚Šå°‚ç”¨
      - ./output:/output:rw # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: æ›¸ãè¾¼ã¿ã¯åˆ¶é™ã•ã‚ŒãŸé ˜åŸŸã®ã¿
    restart: unless-stopped
    command:
      - python
      - services/datetime/datetime_validator.py
      - --directory
      - /workspace
    networks:
      - mcp-network
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ç‰¹æ¨©ç„¡åŠ¹åŒ–
    privileged: false
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE # å¿…è¦æœ€å°é™ã®æ¨©é™ã®ã¿

  actions-simulator:
    build:
      context: .
      dockerfile: Dockerfile.actions
      args:
        USER_ID: "${USER_ID:-1000}"
        GROUP_ID: "${GROUP_ID:-1000}"
    container_name: mcp-actions-simulator
    user: "${USER_ID:-1000}:${GROUP_ID:-1000}"
    group_add:
      - "${DOCKER_GID:-999}"  # Docker group ID for socket access
    volumes:
      - ./.github:/app/.github:ro # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
      - ./output:/app/output:rw # å®Ÿè¡Œçµæœå‡ºåŠ›
      - ./logs:/app/logs:rw # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›
      - act-cache:/opt/act/cache:rw # actã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆèª­ã¿æ›¸ãå¯èƒ½ï¼‰
      - uv-cache:/app/.cache/uv:rw # UVã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆèª­ã¿æ›¸ãå¯èƒ½ï¼‰
      - /var/run/docker.sock:/var/run/docker.sock:rw # Dockerã‚¢ã‚¯ã‚»ã‚¹ï¼ˆactç”¨ã€èª­ã¿æ›¸ãå¯èƒ½ï¼‰
      - /tmp:/tmp:rw # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ç”¨
      - act-workspace:/github/workspace:rw # actãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
      - HOST=0.0.0.0
      - PORT=8000
      - ACT_CACHE_DIR=/opt/act/cache
      - ACTIONS_SIMULATOR_ENGINE=act
      - ACTIONS_SIMULATOR_ACT_TIMEOUT_SECONDS=600
      - DOCKER_BUILDKIT=1 # BuildKitæœ‰åŠ¹åŒ–
      - COMPOSE_DOCKER_CLI_BUILD=1 # Docker Compose CLI Buildæœ‰åŠ¹åŒ–
      - ACT_LOG_LEVEL=${ACT_LOG_LEVEL:-info} # actãƒ­ã‚°ãƒ¬ãƒ™ãƒ«
      - DOCKER_API_VERSION=${DOCKER_API_VERSION:-1.41} # Docker APIãƒãƒ¼ã‚¸ãƒ§ãƒ³
      - PYTHONUNBUFFERED=1 # Pythonå‡ºåŠ›ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ç„¡åŠ¹åŒ–
      - ACTIONS_RUNNER_DEBUG=${ACTIONS_RUNNER_DEBUG:-false} # GitHub Actionsãƒ‡ãƒãƒƒã‚°
      - RUNNER_DEBUG=${RUNNER_DEBUG:-false} # ãƒ©ãƒ³ãƒŠãƒ¼ãƒ‡ãƒãƒƒã‚°
      - ACT_PLATFORM=${ACT_PLATFORM:-ubuntu-latest=catthehacker/ubuntu:act-latest} # actãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
      - ACT_CONTAINER_DAEMON_SOCKET=/var/run/docker.sock # ã‚³ãƒ³ãƒ†ãƒŠå†…Dockerã‚½ã‚±ãƒƒãƒˆ
      - UV_CACHE_DIR=/app/.cache/uv # UV cache directory
      - HOME=/app # Set HOME directory for user
      - USER_ID=${USER_ID:-1000}
      - GROUP_ID=${GROUP_ID:-1000}
      - DOCKER_GID=${DOCKER_GID:-999}
    profiles:
      - tools
    command: ["bash", "-c", "uv run python main.py actions --help"]
    networks:
      - mcp-network

  # Actions Simulator - å¸¸é§ã‚µãƒ¼ãƒãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
  actions-server:
    build:
      context: .
      dockerfile: Dockerfile.actions
      args:
        USER_ID: "${USER_ID:-1000}"
        GROUP_ID: "${GROUP_ID:-1000}"
    container_name: mcp-actions-server
    ports:
      - "8000:8000" # HTTPã‚µãƒ¼ãƒãƒ¼ãƒãƒ¼ãƒˆ
    volumes:
      - ./.github:/app/.github:rw # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆèª­ã¿æ›¸ãå¯èƒ½ - ãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      - ./output:/app/output:rw # å®Ÿè¡Œçµæœå‡ºåŠ›
      - ./logs:/app/logs:rw # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›
      - ./services:/app/services:rw # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
      - ./src:/app/src:rw # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
      - ./main.py:/app/main.py:rw # ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
      - act-cache:/opt/act/cache:rw # actã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆèª­ã¿æ›¸ãå¯èƒ½ï¼‰
      - uv-cache:/app/.cache/uv:rw # UVã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆèª­ã¿æ›¸ãå¯èƒ½ï¼‰
      - /var/run/docker.sock:/var/run/docker.sock:rw # Dockerã‚¢ã‚¯ã‚»ã‚¹ï¼ˆactç”¨ã€èª­ã¿æ›¸ãå¯èƒ½ï¼‰
      - /tmp:/tmp:rw # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ç”¨
      - act-workspace:/github/workspace:rw # actãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
      - HOST=0.0.0.0
      - PORT=8000
      - ACT_CACHE_DIR=/opt/act/cache
      - ACTIONS_SIMULATOR_ENGINE=act
      - ACTIONS_SIMULATOR_ACT_TIMEOUT_SECONDS=600
      - DOCKER_BUILDKIT=1 # BuildKitæœ‰åŠ¹åŒ–
      - COMPOSE_DOCKER_CLI_BUILD=1 # Docker Compose CLI Buildæœ‰åŠ¹åŒ–
      - ACT_LOG_LEVEL=${ACT_LOG_LEVEL:-debug} # ãƒ‡ãƒãƒƒã‚°ç”¨ã«ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’ä¸Šã’ã‚‹
      - DOCKER_API_VERSION=${DOCKER_API_VERSION:-1.41} # Docker APIãƒãƒ¼ã‚¸ãƒ§ãƒ³
      - PYTHONUNBUFFERED=1 # Pythonå‡ºåŠ›ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ç„¡åŠ¹åŒ–
      - ACTIONS_RUNNER_DEBUG=${ACTIONS_RUNNER_DEBUG:-true} # GitHub Actionsãƒ‡ãƒãƒƒã‚°æœ‰åŠ¹
      - RUNNER_DEBUG=${RUNNER_DEBUG:-true} # ãƒ©ãƒ³ãƒŠãƒ¼ãƒ‡ãƒãƒƒã‚°æœ‰åŠ¹
      - ACT_PLATFORM=${ACT_PLATFORM:-ubuntu-latest=catthehacker/ubuntu:act-latest} # actãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
      - ACT_CONTAINER_DAEMON_SOCKET=/var/run/docker.sock # ã‚³ãƒ³ãƒ†ãƒŠå†…Dockerã‚½ã‚±ãƒƒãƒˆ
      - UV_CACHE_DIR=/app/.cache/uv # UV cache directory
      - HOME=/app # Set HOME directory for user
      - ACTIONS_SIMULATOR_VERBOSE=true # è©³ç´°ãƒ­ã‚°æœ‰åŠ¹
      - ACTIONS_SIMULATOR_DEBUG=true # ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹
    profiles:
      - debug
    command: ["bash", "-c", "uv run python main.py actions server --host 0.0.0.0 --port 8000 --debug"]
    networks:
      - mcp-network
    stdin_open: true # ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ¢ãƒ¼ãƒ‰
    tty: true # TTYæœ‰åŠ¹
    restart: unless-stopped

  # Actions Simulator - ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚·ã‚§ãƒ«ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
  actions-shell:
    build:
      context: .
      dockerfile: Dockerfile.actions
      args:
        USER_ID: "${USER_ID:-1000}"
        GROUP_ID: "${GROUP_ID:-1000}"
    container_name: mcp-actions-shell
    volumes:
      - ./.github:/app/.github:rw # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆèª­ã¿æ›¸ãå¯èƒ½ï¼‰
      - ./output:/app/output:rw # å®Ÿè¡Œçµæœå‡ºåŠ›
      - ./logs:/app/logs:rw # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›
      - ./services:/app/services:rw # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
      - ./src:/app/src:rw # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
      - ./main.py:/app/main.py:rw # ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
      - act-cache:/opt/act/cache:rw # actã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆèª­ã¿æ›¸ãå¯èƒ½ï¼‰
      - uv-cache:/app/.cache/uv:rw # UVã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆèª­ã¿æ›¸ãå¯èƒ½ï¼‰
      - /var/run/docker.sock:/var/run/docker.sock:rw # Dockerã‚¢ã‚¯ã‚»ã‚¹ï¼ˆactç”¨ã€èª­ã¿æ›¸ãå¯èƒ½ï¼‰
      - /tmp:/tmp:rw # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ç”¨
      - act-workspace:/github/workspace:rw # actãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
      - HOST=0.0.0.0
      - PORT=8000
      - ACT_CACHE_DIR=/opt/act/cache
      - ACTIONS_SIMULATOR_ENGINE=act
      - ACTIONS_SIMULATOR_ACT_TIMEOUT_SECONDS=600
      - DOCKER_BUILDKIT=1 # BuildKitæœ‰åŠ¹åŒ–
      - COMPOSE_DOCKER_CLI_BUILD=1 # Docker Compose CLI Buildæœ‰åŠ¹åŒ–
      - ACT_LOG_LEVEL=${ACT_LOG_LEVEL:-debug} # ãƒ‡ãƒãƒƒã‚°ç”¨ã«ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’ä¸Šã’ã‚‹
      - DOCKER_API_VERSION=${DOCKER_API_VERSION:-1.41} # Docker APIãƒãƒ¼ã‚¸ãƒ§ãƒ³
      - PYTHONUNBUFFERED=1 # Pythonå‡ºåŠ›ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ç„¡åŠ¹åŒ–
      - ACTIONS_RUNNER_DEBUG=${ACTIONS_RUNNER_DEBUG:-true} # GitHub Actionsãƒ‡ãƒãƒƒã‚°æœ‰åŠ¹
      - RUNNER_DEBUG=${RUNNER_DEBUG:-true} # ãƒ©ãƒ³ãƒŠãƒ¼ãƒ‡ãƒãƒƒã‚°æœ‰åŠ¹
      - ACT_PLATFORM=${ACT_PLATFORM:-ubuntu-latest=catthehacker/ubuntu:act-latest} # actãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
      - ACT_CONTAINER_DAEMON_SOCKET=/var/run/docker.sock # ã‚³ãƒ³ãƒ†ãƒŠå†…Dockerã‚½ã‚±ãƒƒãƒˆ
      - UV_CACHE_DIR=/app/.cache/uv # UV cache directory
      - HOME=/app # Set HOME directory for user
      - ACTIONS_SIMULATOR_VERBOSE=true # è©³ç´°ãƒ­ã‚°æœ‰åŠ¹
      - ACTIONS_SIMULATOR_DEBUG=true # ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹
    profiles:
      - debug
    command:
      - "bash"
      - "-c"
      - >
        echo 'ğŸš Actions Simulator Debug Shell';
        echo 'ä½¿ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:';
        echo '  uv run python main.py actions --help';
        echo '  act --help';
        echo '  docker ps';
        echo '';
        exec bash
    networks:
      - mcp-network
    stdin_open: true # ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ¢ãƒ¼ãƒ‰
    tty: true # TTYæœ‰åŠ¹
    # æ”¹è‰¯ã•ã‚ŒãŸãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¨­å®š
    healthcheck:
      test: [
        "CMD",
        "bash",
        "-c",
        "python -c 'import docker; docker.from_env().ping()' && act --version > /dev/null"
      ]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 30s
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™
    deploy:
      resources:
        limits:
          memory: 4G # actã®å®Ÿè¡Œã«å¿…è¦ãªãƒ¡ãƒ¢ãƒªã‚’å¢—åŠ 
          cpus: "4.0" # CPUãƒªã‚½ãƒ¼ã‚¹ã‚’å¢—åŠ 
        reservations:
          memory: 1G # æœ€å°ãƒ¡ãƒ¢ãƒªäºˆç´„ã‚’å¢—åŠ 
          cpus: "1.0" # æœ€å°CPUäºˆç´„ã‚’å¢—åŠ 
    # Dockerçµ±åˆã®ãŸã‚ã®æ¨©é™è¨­å®š
    privileged: false
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - DAC_OVERRIDE # ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼ˆactç”¨ï¼‰
      - SETUID # UIDå¤‰æ›´ï¼ˆactç”¨ï¼‰
      - SETGID # GIDå¤‰æ›´ï¼ˆactç”¨ï¼‰
      - SYS_PTRACE # ãƒ—ãƒ­ã‚»ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      - CHOWN # ãƒ•ã‚¡ã‚¤ãƒ«æ‰€æœ‰è€…å¤‰æ›´ï¼ˆactç”¨ï¼‰
      - FOWNER # ãƒ•ã‚¡ã‚¤ãƒ«æ‰€æœ‰è€…æ“ä½œï¼ˆactç”¨ï¼‰
    # Docker socket ã‚°ãƒ«ãƒ¼ãƒ—ã‚¢ã‚¯ã‚»ã‚¹
    group_add:
      - "${DOCKER_GID:-999}" # Dockerã‚°ãƒ«ãƒ¼ãƒ—ã¸ã®è¿½åŠ 
    # ä¾å­˜é–¢ä¿‚è¨­å®šï¼ˆä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ï¼‰
    # depends_on:
    #   - docker-health-check
    # å†èµ·å‹•ãƒãƒªã‚·ãƒ¼
    restart: unless-stopped
    # ãƒ­ã‚°è¨­å®š
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
        labels: "service=actions-simulator"

  # Dockeræ¥ç¶šãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç”¨ã‚µãƒ¼ãƒ“ã‚¹
  docker-health-check:
    image: docker:24-cli
    container_name: mcp-docker-health-check
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command:
      [
        "sh",
        "-c",
        "docker version && docker info && echo 'Docker daemon is healthy'",
      ]
    networks:
      - mcp-network
    healthcheck:
      test: ["CMD", "docker", "version"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: "no" # ä¸€åº¦å®Ÿè¡Œã•ã‚Œã‚Œã°çµ‚äº†
    profiles:
      - tools

networks:
  mcp-network:
    driver: bridge

volumes:
  act-cache:
  act-workspace:
  uv-cache:
