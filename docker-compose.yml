---
services:
  github-mcp:
    build: .
    container_name: mcp-github
    environment:
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_PERSONAL_ACCESS_TOKEN}
    ports:
      - "8080:8080"
    restart: unless-stopped
    command: mcp-server-github
    networks:
      - mcp-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  datetime-validator:
    build: .
    container_name: mcp-datetime
    # セキュリティ: 動的UID/GID設定（書き込み権限確保 + Root昇格防止）
    user: "${USER_ID:-1000}:${GROUP_ID:-1000}"
    volumes:
      - ~/workspace:/workspace:ro  # セキュリティ: 読み取り専用
      - ./output:/output:rw         # セキュリティ: 書き込みは制限された領域のみ
    environment:
      - PYTHONPATH=/home/mcp/.local/lib/python3.12/site-packages:/app
    restart: unless-stopped
    command: python datetime_validator.py --directory /workspace
    networks:
      - mcp-network
    # セキュリティ: リソース制限
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    # セキュリティ: 特権無効化
    privileged: false
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # 必要最小限の権限のみ

  codeql:
    build: .
    container_name: mcp-codeql
    volumes:
      - ~/workspace:/workspace
    profiles:
      - tools
    command: codeql --help
    networks:
      - mcp-network

networks:
  mcp-network:
    driver: bridge
